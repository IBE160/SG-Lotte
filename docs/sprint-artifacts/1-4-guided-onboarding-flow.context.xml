<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>4</storyId>
    <title>Guided Onboarding Flow</title>
    <status>drafted</status>
    <generatedAt>torsdag 4. desember 2025</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-4-guided-onboarding-flow.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>As a new user who has just verified my email</asA>
    <iWant>I want to complete a guided 5-step onboarding process</iWant>
    <soThat>So the AI can gather my preferences and generate my first personalized plan.</soThat>
    <tasks>
### Frontend Tasks

-   [ ] **Task: Implement Onboarding UI (5 screens)**
    -   [ ] Create React components for each of the 5 onboarding screens (e.g., `OnboardingStep1.tsx`, `OnboardingStep2.tsx`, etc.) within `frontend/app/(auth)/onboarding/`. (AC: 1, 2)
    -   [ ] Implement navigation logic (e.g., "Next", "Back" buttons) between onboarding screens. (AC: 1)
    -   [ ] Integrate UI elements for selecting fitness goal, dietary preferences, and fitness persona on respective screens. (AC: 2)
    -   [ ] Implement client-side validation for all user inputs within the onboarding flow. (AC: 2)
    -   [ ] **Test Subtask:** Write component tests for each onboarding screen using React Testing Library and Jest, covering input changes, selections, and navigation. (Ref: `docs/architecture-2025-11-30.md` - Frontend Testing)

-   [ ] **Task: Integrate Supabase Client for Saving Preferences**
    -   [ ] Develop utility functions (if not existing) in `frontend/lib/supabase.ts` or a related file to handle user profile updates. (Ref: Learnings from Story 1.3)
    -   [ ] Implement the logic to securely save user preferences (fitness goal, dietary preferences, fitness persona) to the user's profile in Supabase upon completion of the onboarding flow. (AC: 3)
    -   [ ] Handle success/error feedback during saving preferences using principles from `feedback_patterns_dark.html`. (AC: 3)
    -   [ ] **Test Subtask:** Write integration tests for the preference saving logic, mocking Supabase client calls to ensure proper data transmission and error handling.

### Backend Tasks

-   [ ] **Task: Create API Endpoint for User Preferences**
    -   [ ] Define a PUT or POST endpoint (e.g., `/api/v1/users/preferences`) in `backend/app/api/v1/endpoints/users.py` (or a new dedicated preferences endpoint). (AC: 3)
    -   [ ] Implement request body validation using a Pydantic schema for fitness goal, dietary preferences, and fitness persona. (AC: 3)
    -   [ ] Integrate with the Supabase client on the backend to update the user's profile or a dedicated preferences table. (AC: 3)
    -   [ ] Ensure proper authentication (JWT validation) and authorization (RLS considerations) for this endpoint. (Ref: `docs/architecture-2025-11-30.md` - Authentication & Authorization) (AC: 3)
    -   [ ] **Test Subtask:** Write integration tests for the new API endpoint covering successful updates, invalid input, and unauthorized access scenarios. (Ref: `docs/architecture-2025-11-30.md` - Backend Testing)

### Database / General Tasks

-   [ ] **Task: Update User Profile Schema (Alembic Migration)**
    -   [ ] If necessary, create an Alembic migration script to add or update columns in the Supabase user profile table for `fitness_goal`, `dietary_preferences`, and `fitness_persona`. (Ref: `docs/tech-spec-epic-1.md` - Database Design) (AC: 3)
    -   [ ] Ensure the migration is reversible.
    -   [ ] **Test Subtask:** Verify the migration applies and downgrades correctly in a local development environment.
    </tasks>
  </story>

  <acceptanceCriteria>
1.  **Onboarding Flow Presentation:**
    *   **Given** a user has just verified their email
    *   **When** they initiate the onboarding process
    *   **Then** they are presented with a series of 5 distinct UI screens, as specified by `onboarding1_dark.html` through `onboarding5_dark.html` in the UX Design Specification.

2.  **Preference Selection:**
    *   **Given** the user is navigating through the onboarding screens
    *   **When** they interact with the input fields and selection options
    *   **Then** they can effectively choose and input their primary fitness goal, dietary preferences, and fitness persona.

3.  **Secure Preference Saving:**
    *   **Given** the user has completed all onboarding steps and inputs
    *   **When** they submit their preferences
    *   **Then** all selected preferences are securely saved to their user profile in the Supabase database.
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>FR-001: User Authentication & Profile Management</section>
        <snippet>The system shall allow users to securely register, log in, and manage their core profile information. Users can edit their primary fitness goal and core dietary preference.</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>Success Criteria: Effective Onboarding</section>
        <snippet>Less than 10% of new users fail to complete the onboarding process and generate their first plan.</snippet>
      </doc>
      <doc>
        <path>docs/architecture-2025-11-30.md</path>
        <title>Architecture</title>
        <section>Project Context</section>
        <snippet>The AI Fitness & Meal Planner is a greenfield web application leveraging Next.js (frontend), FastAPI (backend), and Supabase (database, authentication). UX includes high-fidelity dark-themed wireframes for a 5-step onboarding.</snippet>
      </doc>
      <doc>
        <path>docs/architecture-2025-11-30.md</path>
        <title>Architecture</title>
        <section>Project Structure</section>
        <snippet>The frontend onboarding UI will reside within `frontend/src/app/(auth)/`.</snippet>
      </doc>
      <doc>
        <path>docs/architecture-2025-11-30.md</path>
        <title>Architecture</title>
        <section>Epic to Architecture Mapping</section>
        <snippet>Epic 1 (First Plan & Foundation) maps to `frontend: src/app/(auth)/` (Onboarding UI).</snippet>
      </doc>
      <doc>
        <path>docs/architecture-2025-11-30.md</path>
        <title>Architecture</title>
        <section>Naming Patterns</section>
        <snippet>Frontend components use PascalCase (e.g., `UserCard.tsx`), and files use Kebab-case (e.g., `user-card.tsx`).</snippet>
      </doc>
      <doc>
        <path>docs/architecture-2025-11-30.md</path>
        <title>Architecture</title>
        <section>Structure Patterns: Component Organization</section>
        <snippet>Components will be organized by feature or route (e.g., `components/dashboard/`, `components/auth/`).</snippet>
      </doc>
      <doc>
        <path>docs/architecture-2025-11-30.md</path>
        <title>Architecture</title>
        <section>Structure Patterns: Shared Utilities (Frontend)</section>
        <snippet>Reusable functions and utilities will be placed in `frontend/src/lib/`.</snippet>
      </doc>
      <doc>
        <path>docs/architecture-2025-11-30.md</path>
        <title>Architecture</title>
        <section>Testing Strategy</section>
        <snippet>Frontend (Next.js): Component and integration tests will be written using `React Testing Library` with `Jest`.</snippet>
      </doc>
      <doc>
        <path>docs/architecture-2025-11-30.md</path>
        <title>Architecture</title>
        <section>Security Architecture</section>
        <snippet>Authentication is handled by Supabase Auth (JWTs). Authorization uses Supabase RLS. Data is encrypted in transit and at rest.</snippet>
      </doc>
      <doc>
        <path>docs/ux-design-specification.md</path>
        <title>UX Design Specification</title>
        <section>Flow 0: New User Onboarding</section>
        <snippet>A 5-step guided setup process for new users, supported by wireframes `onboarding1_dark.html` to `onboarding5_dark.html`.</snippet>
      </doc>
      <doc>
        <path>docs/ux-design-specification.md</path>
        <title>UX Design Specification</title>
        <section>Flow 3 & 4: Log Workouts, Meals & Provide Feedback</section>
        <snippet>Feedback patterns are defined by `feedback_patterns_dark.html` for success, error, and warning messages after user actions.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Epic 1: First Plan & Foundation</section>
        <snippet>As a new user, I can sign up, set my core goals, and get my first personalized workout and meal plan within minutes, so I can start my health journey immediately. High-level scope includes a 5-step guided onboarding flow.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>FR Coverage Map</section>
        <snippet>FR-001 (User Authentication & Profile Management) is covered by Epic 1 and Epic 3, specifically Story 1.3, 1.4, 3.1, 3.3.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>frontend/app/(auth)/signup/</path>
        <kind>component</kind>
        <reason>Existing UI patterns for user input forms.</reason>
      </artifact>
      <artifact>
        <path>frontend/app/(auth)/verify-email/</path>
        <kind>component</kind>
        <reason>Existing UI patterns for user feedback and state management.</reason>
      </artifact>
      <artifact>
        <path>frontend/lib/supabase.ts</path>
        <kind>utility</kind>
        <symbol>Supabase client</symbol>
        <reason>Centralized Supabase client initialization and interaction for data saving.</reason>
      </artifact>
      <artifact>
        <path>backend/app/api/v1/endpoints/users.py</path>
        <kind>endpoint</kind>
        <symbol>/api/v1/users/preferences (PUT/POST)</symbol>
        <reason>Existing user endpoint to be modified or extended for saving user preferences.</reason>
      </artifact>
      <artifact>
        <path>backend/app/schemas/user_preferences.py</path>
        <kind>schema</kind>
        <reason>Pydantic schema for validating user preferences.</reason>
      </artifact>
    </code>
    <dependencies>
      <ecosystem name="Node.js/Frontend">
        <package name="next" version="16.0.7" />
        <package name="react" version="19.2.0" />
        <package name="react-dom" version="19.2.0" />
        <package name="@supabase/ssr" version="0.8.0" />
        <package name="@supabase/supabase-js" version="2.43.4" />
        <package name="tailwindcss" version="^4" />
        <package name="typescript" version="^5" />
        <package name="jest" version="^30.2.0" />
        <package name="@testing-library/react" version="^16.3.0" />
        <package name="@testing-library/jest-dom" version="^6.9.1" />
        <package name="eslint" version="^9" />
      </ecosystem>
      <ecosystem name="Python/Backend">
        <package name="FastAPI" />
        <package name="uvicorn" />
        <package name="SQLAlchemy" />
        <package name="psycopg2-binary" />
        <package name="alembic" />
        <package name="python-dotenv" />
        <package name="supabase" />
        <package name="pytest" />
        <package name="pydantic[email]" />
      </ecosystem>
      <ecosystem name="Database/BaaS">
        <package name="Supabase" version="PostgreSQL" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Frontend UI components for onboarding should reside in `frontend/app/(auth)/onboarding/`.</constraint>
    <constraint>Frontend component naming: `PascalCase` for React components, `kebab-case` for component files.</constraint>
    <constraint>Frontend testing: `React Testing Library` with `Jest`.</constraint>
    <constraint>Backend API endpoints for user preferences: adhere to `/api/v1/users/preferences` (PUT/POST) and use Pydantic validation.</constraint>
    <constraint>Backend API authentication: JWT validation.</constraint>
    <constraint>Backend API authorization: RLS considerations.</constraint>
    <constraint>Database schema updates: Alembic migrations for `fitness_goal`, `dietary_preferences`, and `fitness_persona`.</constraint>
    <constraint>Supabase client in `frontend/lib/supabase.ts` for consistent data interaction.</constraint>
    <constraint>API errors: Standardized JSON format `{ "detail": "Error message" }`.</constraint>
    <constraint>HTTP status codes: Standard (e.g., 200, 400, 401, 500).</constraint>
    <constraint>Logging: Structured JSON format.</constraint>
    <constraint>Date/Time: ISO 8601, UTC.</constraint>
    <constraint>Backend testing: `Pytest`.</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>User Preferences API</name>
      <kind>REST endpoint</kind>
      <signature>PUT/POST /api/v1/users/preferences</signature>
      <path>backend/app/api/v1/endpoints/users.py</path>
    </interface>
    <interface>
      <name>Supabase Client `updateUserPreferences`</name>
      <kind>function signature</kind>
      <signature>(userId: string, preferences: UserPreferences) => Promise&lt;void&gt;</signature>
      <path>frontend/lib/supabase.ts</path>
    </interface>
  </interfaces>
  <tests>
    <standards>Frontend testing will use React Testing Library with Jest for component and integration tests, with test files co-located with components in `__tests__` subdirectories. Backend testing will use Pytest for unit and integration tests, with all tests residing in the root `tests/` directory.</standards>
    <locations>
      <location>frontend/src/app/(auth)/onboarding/__tests__/*.tsx</location>
      <location>frontend/__tests__/**/*.tsx</location>
      <location>backend/tests/**/*.py</location>
    </locations>
    <ideas>
      <idea acId="AC1">Component tests for each of the 5 onboarding screens (e.g., `OnboardingStep1.tsx`), verifying correct UI rendering and navigation.</idea>
      <idea acId="AC2">Component tests for onboarding screens, covering user input changes and selection options for fitness goal, dietary preferences, and fitness persona.</idea>
      <idea acId="AC3">Frontend Integration tests for preference saving logic, mocking Supabase client calls to ensure proper data transmission and error handling.</idea>
      <idea acId="AC3">Backend Integration tests for the `/api/v1/users/preferences` endpoint, covering successful updates, invalid input, and unauthorized access.</idea>
      <idea acId="AC3">Database: Verify Alembic migration applies and downgrades correctly.</idea>
    </ideas>
  </tests>
</story-context>
