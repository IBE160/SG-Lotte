<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>Epic 2</epicId>
    <storyId>2.5</storyId>
    <title>New Plan Notification</title>
    <status>drafted</status>
    <generatedAt>2025-12-02</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-5-new-plan-notification.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>As an active user</asA>
    <iWant>I want to be notified when my new weekly plans are ready</iWant>
    <soThat>so I know when to check for updates.</soThat>
    <tasks>
| Task ID | Description | Est. Time |
|---|---|---|
| 2.5.1 | Create the backend endpoint to trigger and manage in-app notifications. (AC: #1) | 3h |
| 2.5.2 | Implement the frontend UI for the notification based on the `feedback_patterns_dark.html` concept. (AC: #1, #2) | 3h |
| 2.5.3 | Implement the client-side logic to check for new notifications and display them. (AC: #1, #2) | 2h |
| 2.5.4 | **Test:** Write unit tests for the frontend UI of the notification. (AC: #1) | 1.5h |
| 2.5.5 | **Test:** Write integration tests for the backend endpoint to trigger and manage notifications. (AC: #1) | 1.5h |
| 2.5.6 | **Test:** Write E2E tests for the complete notification system, verifying display and navigation. (AC: #1, #2) | 1.5h |
</tasks>
  </story>

  <acceptanceCriteria>
| # | Given | When | Then |
|---|---|---|---|
| 1 | A new plan has been generated by the AI | I open the app | I receive an in-app notification confirming the new plan |
| 2 | I receive a new plan notification | I interact with the notification | I can easily navigate to the new plan |
</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>PRD.md</path>
        <title>ibe160 - Product Requirements Document</title>
        <section>FR-007: Notifications</section>
        <snippet>The system shall notify users when their new weekly plans are ready. Users receive an in-app notification when new weekly plans are generated.</snippet>
      </doc>
      <doc>
        <path>ux-design-specification.md</path>
        <title>AI Fitness &amp; Meal Planner - UX Design Specification (Rev. 2)</title>
        <section>Flow 3 &amp; 4: Log Workouts, Meals &amp; Provide Feedback</section>
        <snippet>Supporting Wireframes: `feedback_patterns_dark.html`: Defines the visual patterns (toasts) for success, error, and warning feedback after a user action.</snippet>
      </doc>
      <doc>
        <path>epics.md</path>
        <title>ibe160 - Epic Breakdown</title>
        <section>Epic 2: Adaptive Planning &amp; Progress Logging</section>
        <snippet>As an active user, I can log my progress with simple clicks, and the app will automatically adapt my next week's plan to my performance, so my plan evolves with me. High-level scope: ... in-app notifications for new plans.</snippet>
      </doc>
      <doc>
        <path>sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic Technical Specification: Adaptive Planning &amp; Progress Logging</title>
        <section>Objectives and Scope</section>
        <snippet>New Plan Notifications: A simple in-app notification system to alert users when their new weekly plan is available.</snippet>
      </doc>
      <doc>
        <path>sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic Technical Specification: Adaptive Planning &amp; Progress Logging</title>
        <section>Detailed Design: Services and Modules</section>
        <snippet>Backend Notification Service: Create an in-app notification when a new weekly plan has been generated.</snippet>
      </doc>
      <doc>
        <path>sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic Technical Specification: Adaptive Planning &amp; Progress Logging</title>
        <section>Detailed Design: Data Models and Contracts</section>
        <snippet>The `notifications` table stores in-app notifications for users, including `id`, `user_id`, `message`, `is_read`, `created_at`.</snippet>
      </doc>
      <doc>
        <path>sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic Technical Specification: Adaptive Planning &amp; Progress Logging</title>
        <section>Detailed Design: APIs and Interfaces</section>
        <snippet>GET /notifications: Fetches all unread notifications for the authenticated user. Response (200 OK): `[{ "id": "...", "message": "Your new weekly plan is ready!", "is_read": false, "created_at": "..." }]`.</snippet>
      </doc>
      <doc>
        <path>sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic Technical Specification: Adaptive Planning &amp; Progress Logging</title>
        <section>Workflows and Sequencing</section>
        <snippet>Notification: Upon successful creation of the new plan, the service creates a "Your new weekly plan is ready!" notification and saves it to the `notifications` table. User Alert: The next time the user opens the app, the frontend fetches and displays the unread notification.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>backend/app/api/v1/endpoints/plans.py</path>
        <kind>backend endpoint</kind>
        <symbol>manage_notifications</symbol>
        <reason>Endpoint to trigger and manage in-app notifications (e.g., creation, mark as read).</reason>
      </artifact>
      <artifact>
        <path>frontend/src/components/shared/notifications/NotificationDisplay.tsx</path>
        <kind>frontend component</kind>
        <symbol>NotificationDisplay</symbol>
        <reason>UI component for displaying in-app notifications.</reason>
      </artifact>
      <artifact>
        <path>backend/app/models/notifications.py</path>
        <kind>database model</kind>
        <symbol>Notification</symbol>
        <reason>Database model for storing in-app notifications.</reason>
      </artifact>
    </code>
    <dependencies>
      <ecosystem name="Node.js">
        <package>zustand</package>
        <package>react</package>
        <package>react-dom</package>
        <package>next</package>
        <package>typescript</package>
        <package>tailwindcss</package>
      </ecosystem>
      <ecosystem name="Python">
        <package>fastapi</package>
        <package>pydantic</package>
        <package>supabase</package>
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Backend endpoint to trigger and manage notifications should be added to `backend/app/api/v1/endpoints/plans.py`.</constraint>
    <constraint>Frontend UI for notifications should be created as a shared component, potentially in `frontend/src/components/shared/notifications/`.</constraint>
    <constraint>Notification should be non-intrusive yet clearly visible.</constraint>
    <constraint>Backend service creates a notification upon successful plan creation and saves to `notifications` table.</constraint>
    <constraint>Frontend checks on app load for notification retrieval.</constraint>
    <constraint>Frontend fetches unread notifications from `GET /notifications` endpoint.</constraint>
    <constraint>The `notifications` table must conform to the defined data model, including `message` and `is_read`.</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>Get Notifications</name>
      <kind>REST endpoint</kind>
      <signature>GET /api/v1/notifications</signature>
      <path>backend/app/api/v1/endpoints/plans.py</path>
    </interface>
    <interface>
      <name>Mark Notification as Read</name>
      <kind>REST endpoint</kind>
      <signature>POST /api/v1/notifications/{notification_id}/mark-read</signature>
      <path>backend/app/api/v1/endpoints/plans.py</path>
    </interface>
  </interfaces>
  <tests>
    <standards>
      Backend unit and integration tests will use Pytest. Frontend component and integration tests will use React Testing Library with Jest. E2E tests will utilize Playwright. Test files will be co-located with components or in root `tests/` directory for backend.
    </standards>
    <locations>
      <location>backend/tests/</location>
      <location>frontend/src/**/__tests__/</location>
    </locations>
    <ideas>
      <idea ac_id="AC: #1">Unit tests for the frontend UI of the notification.</idea>
      <idea ac_id="AC: #1">Integration tests for the backend endpoint to trigger and manage notifications.</idea>
      <idea ac_id="AC: #1, #2">E2E tests for the complete notification system, verifying display and navigation.</idea>
    </ideas>
  </tests>
</story-context>