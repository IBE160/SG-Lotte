# Story 1.5: Initial AI Plan Generation & Display

Status: drafted

## Story

As a new user who has completed onboarding,
I want to immediately see my first AI-generated "diagnostic" workout and meal plan on my dashboard,
So I can begin my health journey.

## Acceptance Criteria

1.  **Given** I have completed the onboarding flow,
    **When** my dashboard loads,
    **Then** a 7-day personalized workout and meal plan is generated by the AI (Pydantic AI framework with Gemini 2.5).
    *   **Source:** Epics.md (Story 1.5), Tech-Spec-Epic-1.md (AC 14)
2.  **Given** I have completed the onboarding flow,
    **When** my dashboard loads,
    **Then** the generated plan is displayed on the dashboard, similar to `dashboard_dark.html` (showing today's plan).
    *   **Source:** Epics.md (Story 1.5), Tech-Spec-Epic-1.md (AC 15)
3.  **Given** I have completed the onboarding flow,
    **When** my dashboard loads,
    **Then** the plan details are stored in the database.
    *   **Source:** Epics.md (Story 1.5), Tech-Spec-Epic-1.md (AC 16)

---

## Tasks / Subtasks

*   **Backend: AI Plan Generation Service (`ai_plan_generator.py`)**
    *   [ ] Implement `ai_plan_generator.py` service to interact with Pydantic AI framework and Gemini 2.5 (AC: #1)
        *   [ ] Define input parameters based on user preferences (goals, dietary, persona)
        *   [ ] Formulate prompts for Gemini 2.5 to generate 7-day workout and meal plans
        *   [ ] Parse structured JSON response from Gemini 2.5
        *   [ ] Handle potential AI API errors and retries
    *   [ ] Create Pydantic schemas for workout plan and meal plan data structures (AC: #1, #3)
    *   [ ] Implement database integration to store generated plans in `workout_plans` and `meal_plans` tables (AC: #3)
        *   [ ] Define Supabase models for `workout_plans` and `meal_plans`
        *   [ ] Implement CRUD operations for plans
*   **Backend: API Endpoints (`plans.py`)**
    *   [ ] Create FastAPI `POST /api/v1/plans/generate` endpoint (AC: #1, #3)
        *   [ ] Authenticate user via JWT
        *   [ ] Retrieve user preferences from Supabase
        *   [ ] Invoke `ai_plan_generator.py` service
        *   [ ] Store generated plans in DB
        *   [ ] Return confirmation to frontend
    *   [ ] Create FastAPI `GET /api/v1/plans/current` endpoint (AC: #2)
        *   [ ] Authenticate user via JWT
        *   [ ] Retrieve current week's workout and meal plans from DB
        *   [ ] Return structured plan data to frontend
*   **Frontend: Dashboard UI Integration**
    *   [ ] Implement dashboard UI to display generated workout and meal plans (AC: #2)
        *   [ ] Develop components similar to `dashboard_dark.html`
        *   [ ] Integrate with `GET /api/v1/plans/current` to fetch plans
        *   [ ] Visually represent 7-day workout and meal plans
    *   [ ] Integrate `POST /api/v1/plans/generate` call after onboarding completion (AC: #1)
    *   [ ] Handle loading states and error display during plan generation and retrieval
*   **Testing:**
    *   [ ] Write unit and integration tests for `ai_plan_generator.py` (mocking AI API calls)
    *   [ ] Write integration tests for `POST /api/v1/plans/generate` and `GET /api/v1/plans/current` endpoints (mocking Supabase interactions)
    *   [ ] Write component and integration tests for frontend dashboard UI (mocking API calls)
    *   [ ] Implement E2E test for the full flow: onboarding completion -> plan generation -> dashboard display (future consideration, beyond MVP for this story)

## Dev Notes

### Relevant architecture patterns and constraints

*   **Frontend Architecture:** Next.js (App Router), TypeScript, Tailwind CSS. Dashboard UI components will likely reside in `frontend/src/app/(dashboard)/dashboard/`.
*   **Backend Architecture:** FastAPI (Python). API endpoints for plan management will be under `app/api/v1/endpoints/plans.py` or a new plans-related endpoint. AI plan generation logic will be encapsulated in `app/services/ai_plan_generator.py`.
*   **Data Persistence:** Supabase (PostgreSQL) for storing `workout_plans` and `meal_plans` data. Supabase Auth for user management and JWTs for API authentication.
*   **API Contracts:** Frontend will communicate with FastAPI backend via versioned REST API (`/api/v1/`). Requests and responses will use Pydantic schemas.
*   **Security:** RLS must be enforced for user-specific plans.
*   **AI Integration:** Pydantic AI framework with Gemini 2.5 for plan generation.

### Source tree components to touch

*   **Frontend:**
    *   `frontend/src/app/(dashboard)/dashboard/`: New pages/components for displaying the plan.
    *   `frontend/src/app/(auth)/onboarding/page.tsx`: Modify to trigger `POST /api/v1/plans/generate` after onboarding.
    *   `frontend/src/components/`: New reusable UI components if any.
    *   `frontend/src/lib/supabaseClient.ts`: Potentially update if new Supabase interactions are needed.
*   **Backend:**
    *   `backend/src/app/api/v1/endpoints/plans.py`: New endpoints for `generate` and `current` plans.
    *   `backend/src/app/schemas/`: Define new Pydantic schemas for plan data.
    *   `backend/src/app/crud/`: Implement CRUD operations for `workout_plans` and `meal_plans`.
    *   `backend/src/app/models/`: Potentially update or add models for `workout_plans` and `meal_plans` in the database.
    *   `backend/src/app/services/ai_plan_generator.py`: New service for AI interaction.
    *   `backend/src/main.py`: Update to include new endpoints.

### Testing standards summary

*   **Backend (FastAPI):** Unit and integration tests using `Pytest`. Mock AI API calls.
*   **Frontend (Next.js):** Component and integration tests using `React Testing Library` with `Jest`. Mock API calls.
*   All API endpoints and UI interactions related to plan generation and display should be thoroughly tested.

### Project Structure Notes

*   Frontend dashboard components should reside within `frontend/src/app/(dashboard)/dashboard/` to maintain the existing structure.
*   New backend API endpoints and associated logic should follow the established `backend/app/api/v1/endpoints/`, `backend/app/schemas/`, `backend/app/crud/`, `backend/app/models/`, and `backend/app/services/` structure.

### References

- [Source: docs/epics.md#Story 1.5: Initial AI Plan Generation & Display]
- [Source: docs/PRD.md#FR-002: AI-Driven Workout Plan Generation & Adaptation]
- [Source: docs/PRD.md#FR-003: AI-Driven Meal Plan Generation & Adaptation]
- [Source: docs/PRD.md#FR-006: Dashboard Overview]
- [Source: docs/architecture-2025-11-30.md#Epic to Architecture Mapping]
- [Source: docs/architecture-2025-11-30.md#Project Structure]
- [Source: docs/architecture-2025-11-30.md#Testing Strategy]
- [Source: docs/coding-standards.md#Overview]
- [Source: docs/sprint-artifacts/tech-spec-epic-1.md#Story 1.5: Initial AI Plan Generation & Display]

## Dev Agent Record

### Context Reference

<!-- Path(s) to story context XML will be added here by context workflow -->

### Agent Model Used

Gemini CLI

### Debug Log References

### Completion Notes List

### File List

---

### Learnings from Previous Story

**From Story 1-4-guided-onboarding-flow (Status: done)**

-   **New Services Created**:
    -   `backend/src/app/services/user_profile_service.py`: This service handles user preferences and can be extended or reused for general user profile management.
    -   `backend/src/app/api/v1/endpoints/onboarding.py`: This endpoint now manages onboarding-specific API interactions.
-   **Architectural Change**: Backend test environment fixed by correcting import paths and using FastAPI's idiomatic dependency overrides.
-   **Technical Debt**:
    - A single, pre-existing frontend test (`displays validation error for invalid email` in `signup.test.tsx`) remains failing.
    - A weak test assertion in a frontend data submission test.
-   **Review Findings**: The previous story lacked a dedicated `tech-spec-epic-1.md` at its time of drafting, which has now been provided.

[Source: docs/sprint-artifacts/1-4-guided-onboarding-flow.md#Dev-Agent-Record]

## Change Log


