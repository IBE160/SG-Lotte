# Story 1.5: Initial AI Plan Generation & Display

Status: drafted

## Story

As a new user who has completed onboarding,
I want to immediately see my first AI-generated "diagnostic" workout and meal plan on my dashboard,
so that I can begin my health journey.

## Requirements Context Summary

This story focuses on generating the initial "diagnostic" workout and meal plan for a new user immediately after they complete the onboarding process. The generated plan should be a 7-day plan and displayed on the user's dashboard.

### Functional Requirements

- **FR-002: AI-Driven Workout Plan Generation & Adaptation:** The system shall automatically generate and adapt weekly workout plans.
- **FR-003: AI-Driven Meal Plan Generation & Adaptation:** The system shall automatically generate and adapt weekly meal plans.
- **FR-006: Dashboard Overview:** The system shall provide a clear, minimalist dashboard displaying the user's current weekly workout and meal plans.

### Key Components & Files

- **Backend Service:** `app/services/ai_plan_generator.py` is responsible for the AI interaction to generate the plan. [Source: `docs/architecture-2025-11-30.md#Epic-to-Architecture-Mapping`]
- **API Endpoint:** The `/api/v1/plans/` endpoint will be used to trigger plan generation. [Source: `docs/architecture-2025-11-30.md#API-Contracts`]
- **Frontend Display:** The generated plan will be displayed on the dashboard, which is implemented in `src/app/(dashboard)/dashboard/`. [Source: `docs/architecture-2025-11-30.md#Epic-to-Architecture-Mapping`]
- **AI Integration:** The backend will use the Pydantic AI framework with Gemini 2.5. [Source: `docs/architecture-2025-11-30.md#Technology-Stack-Details`]

## Project Structure Alignment & Lessons Learned

### Lessons Learned from Previous Story

Previous story file (`1-4-guided-onboarding-flow.md`) was not found. No learnings can be applied.

### Project Structure Alignment

- **Backend:** The core logic for this story should be implemented in `backend/app/services/ai_plan_generator.py` as per the architecture. A new endpoint will be required under `backend/app/api/v1/endpoints/` to expose this functionality.
- **Frontend:** The dashboard component at `frontend/src/app/(dashboard)/dashboard/page.tsx` will need to be updated to fetch and display the plan.
- **Database:** A new table or tables will be required to store the generated plans. The schema for this should be defined and a migration created using Alembic.

## Acceptance Criteria

1.  **Given** a new user has completed the onboarding flow, **when** their dashboard loads, **then** a 7-day personalized workout and meal plan is generated by the AI.
2.  **Given** a plan has been generated, **then** it is displayed on the user's dashboard, showing today's plan.
3.  **Given** a plan has been generated, **then** the plan details are stored in the database.

## Tasks / Subtasks

-   [ ] **Backend: Database Schema** (AC: #3)
    -   [ ] Define the schema for storing workout and meal plans.
    -   [ ] Create an Alembic migration script for the new tables.
-   [ ] **Backend: AI Service** (AC: #1)
    -   [ ] Implement the `ai_plan_generator.py` service.
    -   [ ] Connect to the AI provider (Pydantic AI with Gemini 2.5).
    -   [ ] Construct the prompt for the AI based on user onboarding data.
    -   [ ] Validate the AI response and parse it into the database schema.
-   [ ] **Backend: API Endpoint** (AC: #1)
    -   [ ] Create a new endpoint in `/api/v1/plans/` to trigger plan generation.
    -   [ ] Secure the endpoint to ensure only the authenticated user can generate their plan.
    -   [ ] Store the generated plan in the database.
-   [ ] **Frontend: Dashboard Integration** (AC: #2)
    -   [ ] Create a data fetching hook to call the new backend endpoint.
    -   [ ] Update the dashboard component to display the generated plan for the current day.
    -   [ ] Implement loading and error states for the dashboard.
-   [ ] **Testing**
    -   [ ] Write unit tests for the `ai_plan_generator.py` service.
    -   [ ] Write integration tests for the new API endpoint.
    -   [ ] Write frontend component tests for the updated dashboard.

## Dev Notes

-   **AI Interaction:** The core of this story is the interaction with the AI. The prompt should be carefully constructed to include all the user's onboarding preferences. The response from the AI needs to be validated against a Pydantic schema to ensure it's in the expected format.
-   **Database:** The plan data should be stored in a structured way that is easy to query and display. Consider using JSONB for flexible plan data.
-   **Frontend:** The dashboard should be designed to handle the asynchronous nature of the plan generation. A loading state should be displayed while the plan is being generated.
-   **Testing:** Mock the AI service during testing to avoid actual calls to the AI provider. This will make the tests faster and more predictable.

### References

-   [Source: `docs/epics.md#Story-1.5-Initial-AI-Plan-Generation--Display`]
-   [Source: `docs/architecture-2025-11-30.md#Epic-to-Architecture-Mapping`]
-   [Source: `docs/architecture-2025-11-30.md#API-Contracts`]
-   [Source: `docs/PRD.md#FR-002-AI-Driven-Workout-Plan-Generation--Adaptation`]
-   [Source: `docs/PRD.md#FR-003-AI-Driven-Meal-Plan-Generation--Adaptation`]
-   [Source: `docs/PRD.md#FR-006-Dashboard-Overview`]

## Dev Agent Record

### Context Reference

<!-- Path(s) to story context XML will be added here by context workflow -->

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List
