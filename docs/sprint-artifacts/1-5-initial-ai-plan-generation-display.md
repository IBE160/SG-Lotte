# Story 1.5: Initial AI Plan Generation & Display

Status: in-progress

## Story

As a new user who has completed onboarding,
I want to immediately see my first AI-generated "diagnostic" workout and meal plan on my dashboard,
so that I can begin my health journey.

## Requirements Context Summary

This story focuses on generating the initial "diagnostic" workout and meal plan for a new user immediately after they complete the onboarding process. The generated plan should be a 7-day plan and displayed on the user's dashboard.

### Functional Requirements

- **FR-002: AI-Driven Workout Plan Generation & Adaptation:** The system shall automatically generate and adapt weekly workout plans.
- **FR-003: AI-Driven Meal Plan Generation & Adaptation:** The system shall automatically generate and adapt weekly meal plans.
- **FR-006: Dashboard Overview:** The system shall provide a clear, minimalist dashboard displaying the user's current weekly workout and meal plans.

### Key Components & Files

- **Backend Service:** `app/services/ai_plan_generator.py` is responsible for the AI interaction to generate the plan. [Source: `docs/architecture-2025-11-30.md#Epic-to-Architecture-Mapping`]
- **API Endpoint:** The `/api/v1/plans/` endpoint will be used to trigger plan generation. [Source: `docs/architecture-2025-11-30.md#API-Contracts`]
- **Frontend Display:** The generated plan will be displayed on the dashboard, which is implemented in `src/app/(dashboard)/dashboard/`. [Source: `docs/architecture-2025-11-30.md#Epic-to-Architecture-Mapping`]
- **AI Integration:** The backend will use the Pydantic AI framework with Gemini 2.5. [Source: `docs/architecture-2025-11-30.md#Technology-Stack-Details`]

## Project Structure Alignment & Lessons Learned

### Lessons Learned from Previous Story

Previous story file (`1-4-guided-onboarding-flow.md`) was not found. No learnings can be applied.

### Project Structure Alignment

- **Backend:** The core logic for this story should be implemented in `backend/app/services/ai_plan_generator.py` as per the architecture. A new endpoint will be required under `backend/app/api/v1/endpoints/` to expose this functionality.
- **Frontend:** The dashboard component at `frontend/src/app/(dashboard)/dashboard/page.tsx` will need to be updated to fetch and display the plan.
- **Database:** A new table or tables will be required to store the generated plans. The schema for this should be defined and a migration created using Alembic.

## Acceptance Criteria

1.  **Given** a new user has completed the onboarding flow, **when** their dashboard loads, **then** a 7-day personalized workout and meal plan is generated by the AI.
2.  **Given** a plan has been generated, **then** it is displayed on the user's dashboard, showing today's plan.
3.  **Given** a plan has been generated, **then** the plan details are stored in the database.

## Tasks / Subtasks

-   [x] **Backend: Database Schema** (AC: #3)
    -   [x] Define the schema for storing workout and meal plans.
    -   [x] Create an Alembic migration script for the new tables.
-   [x] **Backend: AI Service** (AC: #1)
    -   [x] Implement the `ai_plan_generator.py` service.
    -   [x] Connect to the AI provider (Pydantic AI with Gemini 2.5).
    -   [x] Construct the prompt for the AI based on user onboarding data.
    -   [x] Validate the AI response and parse it into the database schema.
-   [x] **Backend: API Endpoint** (AC: #1)
    -   [x] Create a new endpoint in `/api/v1/plans/` to trigger plan generation.
    -   [x] Secure the endpoint to ensure only the authenticated user can generate their plan.
    -   [x] Store the generated plan in the database.
-   [x] **Frontend: Dashboard Integration** (AC: #2)
    -   [x] Create a data fetching hook to call the new backend endpoint.
    -   [x] Update the dashboard component to display the generated plan for the current day.
    -   [x] Implement loading and error states for the dashboard.
-   [x] **Testing**
    -   [x] Write unit tests for the `ai_plan_generator.py` service.
    -   [x] Write integration tests for the new API endpoint.
    -   [x] Write frontend component tests for the updated dashboard.

### Review Follow-ups (AI)

- [x] [Medium] [AI-Review] Address `supabase.auth.admin.updateUserById` usage in `frontend/lib/supabase.ts` (AC #1.4.4, #1.3.4) [file: frontend/lib/supabase.ts]
- [x] [Low] [AI-Review] Integrate actual user preferences for AI plan generation [file: backend/app/api/v1/endpoints/plans.py]

## Dev Notes

-   **AI Interaction:** The core of this story is the interaction with the AI. The prompt should be carefully constructed to include all the user's onboarding preferences. The response from the AI needs to be validated against a Pydantic schema to ensure it's in the expected format.
-   **Database:** The plan data should be stored in a structured way that is easy to query and display. Consider using JSONB for flexible plan data.
-   **Frontend:** The dashboard should be designed to handle the asynchronous nature of the plan generation. A loading state should be displayed while the plan is being generated.
-   **Testing:** Mock the AI service during testing to avoid actual calls to the AI provider. This will make the tests faster and more predictable.

### References

-   [Source: `docs/epics.md#Story-1.5-Initial-AI-Plan-Generation--Display`]
-   [Source: `docs/architecture-2025-11-30.md#Epic-to-Architecture-Mapping`]
-   [Source: `docs/architecture-2025-11-30.md#API-Contracts`]
-   [Source: `docs/PRD.md#FR-002-AI-Driven-Workout-Plan-Generation--Adaptation`]
-   [Source: `docs/PRD.md#FR-003-AI-Driven-Meal-Plan-Generation--Adaptation`]
-   [Source: `docs/PRD.md#FR-006-Dashboard-Overview`]

## Dev Agent Record

### Context Reference

<!-- Path(s) to story context XML will be added here by context workflow -->

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List

### Change Log

- **torsdag 4. desember 2025:** Senior Developer Review notes appended.
- **torsdag 4. desember 2025:** Re-review completed. Outcome: Approve.


### Senior Developer Review (AI)

**Reviewer:** BIP
**Date:** torsdag 4. desember 2025
**Outcome:** Approve

**Summary:**
This re-review confirms that all previously identified action items for Story 1.5 "Initial AI Plan Generation & Display" have been successfully addressed. The implementation now aligns with best practices for security and fully integrates user preferences for AI plan generation. No new issues were introduced during the fixes.

**Key Findings:**
*   None. All previously identified Medium and Low severity findings are now RESOLVED.

**Acceptance Criteria Coverage:**

| AC# | Description | Status | Evidence |
| :-- | :---------------------------------------------------------------------------------------------------------------------------------------------------------- | :----------- | :------------------------------------------------------------------------------------ |
| 1 | Given a new user has completed the onboarding flow, when their dashboard loads, then a 7-day personalized workout and meal plan is generated by the AI. | IMPLEMENTED | `backend/app/services/ai_plan_generator.py:30-74`, `backend/app/api/v1/endpoints/plans.py:16-54` |
| 2 | Given a plan has been generated, then it is displayed on the user's dashboard, showing today's plan. | IMPLEMENTED | `frontend/app/(dashboard)/dashboard/page.tsx:31-122`, `frontend/hooks/usePlan.ts:31-48` |
| 3 | Given a plan has been generated, then it is displayed on the user's dashboard, showing today's plan. | IMPLEMENTED | `backend/app/services/ai_plan_generator.py:61-74`, `backend/app/api/v1/endpoints/plans.py:50`, `backend/app/models/plan.py:6-30`, `backend/alembic/versions/2025_12_04_1100_create_plan_tables.py:17-48` |
| **Summary** | **3 of 3 acceptance criteria fully implemented.** | | |

**Task Completion Validation:**

| Task | Marked As | Verified As | Evidence |
| :------------------------------------------------ | :-------- | :------------ | :------------------------------------------------------------------------------------ |
| **Backend: Database Schema** | | | |
| Define the schema for storing workout and meal plans. | [x] | VERIFIED COMPLETE | `backend/app/models/plan.py:6-30` |
| Create an Alembic migration script for the new tables. | [x] | VERIFIED COMPLETE | `backend/alembic/versions/2025_12_04_1100_create_plan_tables.py:17-48` |
| **Backend: AI Service** | | | |
| Implement the `ai_plan_generator.py` service. | [x] | VERIFIED COMPLETE | `backend/app/services/ai_plan_generator.py:14-74` |
| Connect to the AI provider (Pydantic AI with Gemini 2.5). | [x] | VERIFIED COMPLETE | `backend/app/services/ai_plan_generator.py:10-14` |
| Construct the prompt for the AI based on user onboarding data. | [x] | VERIFIED COMPLETE | `backend/app/services/ai_plan_generator.py:20-33` |
| Validate the AI response and parse it into the database schema. | [x] | VERIFIED COMPLETE | `backend/app/services/ai_plan_generator.py:44-46` |
| **Backend: API Endpoint** | | | |
| Create a new endpoint in `/api/v1/plans/` to trigger plan generation. | [x] | VERIFIED COMPLETE | `backend/app/api/v1/endpoints/plans.py:16` |
| Secure the endpoint to ensure only the authenticated user can generate their plan. | [x] | VERIFIED COMPLETE | `backend/app/api/v1/endpoints/plans.py:18` |
| Store the generated plan in the database. | [x] | VERIFIED COMPLETE | `backend/app/api/v1/endpoints/plans.py:50` |
| **Frontend: Dashboard Integration** | | | |
| Create a data fetching hook to call the new backend endpoint. | [x] | VERIFIED COMPLETE | `frontend/hooks/usePlan.ts:31-48` |
| Update the dashboard component to display the generated plan for the current day. | [x] | VERIFIED COMPLETE | `frontend/app/(dashboard)/dashboard/page.tsx:31-122` |
| Implement loading and error states for the dashboard. | [x] | VERIFIED COMPLETE | `frontend/app/(dashboard)/dashboard/page.tsx:28-66` |
| **Testing** | | | |
| Write unit tests for the `ai_plan_generator.py` service. | [x] | VERIFIED COMPLETE | `backend/tests/services/test_ai_plan_generator.py:1-125` |
| Write integration tests for the new API endpoint. | [x] | VERIFIED COMPLETE | `backend/tests/test_plans.py:1-177` |
| Write frontend component tests for the updated dashboard. | [x] | VERIFIED COMPLETE | `frontend/app/(dashboard)/dashboard/__tests__/page.test.tsx:1-174` |
| **Summary** | **15 of 15 completed tasks verified.** | | |

**Test Coverage and Gaps:**
*   **Backend Unit Tests (`test_ai_plan_generator.py`):** Good coverage of the AI plan generation service, including success and error paths.
*   **Backend Integration Tests (`test_plans.py`):** Comprehensive integration tests for the `/api/v1/plans/generate` endpoint, covering success, authorization, conflict, and various error conditions.
*   **Frontend Component Tests (`page.test.tsx`):** Excellent test coverage for the `DashboardPage` component, including different UI states and user interactions.
*   **Gaps:** No significant test gaps were identified for the implemented features.

**Architectural Alignment:**
The implementation aligns well with the defined architecture and Epic 1 Tech Spec. Key components like `ai_plan_generator.py`, the `/api/v1/plans/generate` endpoint, and the frontend dashboard integration follow the outlined structure and technology choices. The use of SWR for client-side data fetching aligns with the caching strategy (ADR-002).

**Security Notes:**
The previously identified Medium-severity security concern regarding `supabase.auth.admin.updateUserById` has been successfully addressed. The frontend now communicates with a secure backend endpoint for updating user preferences, which is the recommended approach.

**Best-Practices and References:**
The project generally follows good practices for the chosen tech stack (Next.js, FastAPI, Supabase). The use of Pydantic for schema validation and SWR for data fetching are good choices.

**Action Items:**
*   None. All previously identified action items are RESOLVED.