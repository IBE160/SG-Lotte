<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>3</storyId>
    <title>user-registration-email-verification</title>
    <status>drafted</status>
    <generatedAt>onsdag 3. desember 2025</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>C:/IT_studier/IBE160_Programmering_med_KI/Prosjektmappe/Prosjekt/SG-Lotte/docs/sprint-artifacts</sourceStoryPath>
  </metadata>

  <story>
    <asA>As a new user</asA>
    <iWant>to sign up with my email and password and verify my email</iWant>
    <soThat>that I can create a secure account.</soThat>
    <tasks>
        <task title="Create Signup UI Component." ac_refs="1">
            <subtask>Create a new React component for the registration form based on `onboarding1_dark.html`.</subtask>
            <subtask>Place the component in an appropriate directory (e.g., `frontend/components/auth/SignUpForm.tsx`).</subtask>
            <subtask>Implement form fields for email and password with basic validation (e.g., password length).</subtask>
        </task>
        <task title="Integrate Supabase Authentication." ac_refs="1, 2, 3, 4, 5">
            <subtask>Add the `@supabase/supabase-js` package to the frontend.</subtask>
            <subtask>Create a Supabase client utility in `frontend/lib/supabase.ts`.</subtask>
            <subtask>Implement the `supabase.auth.signUp()` function call on form submission.</subtask>
            <subtask>Implement a login function using `supabase.auth.signInWithPassword()`.</subtask>
            <subtask>Protect a test page to verify that un-verified users cannot access it.</subtask>
        </task>
        <task title="Create Email Verification Flow." ac_refs="2, 4">
            <subtask>Configure the email template in the Supabase dashboard (manual step, to be noted).</subtask>
            <subtask>Ensure the verification link redirects to a success page on the frontend.</subtask>
            <subtask>Display a message to the user on the signup page instructing them to check their email.</subtask>
        </task>
        <task title="Write Tests." ac_refs="1, 3, 5">
            <subtask>Write a component test for the `SignUpForm` component to check form rendering and input.</subtask>
            <subtask>Write an integration test to mock the `supabase.auth.signUp` call and verify its behavior on success and error.</subtask>
            <subtask>Write a test to verify that a protected route redirects unauthenticated users.</subtask>
        </task>
    </tasks>
  </story>

  <acceptanceCriteria>
        <criterion id="1">Given I am on the signup page, when I enter a valid email and password and submit, then my account is created in the Supabase `auth.users` table.</criterion>
        <criterion id="2">A verification email is sent to my provided email address.</criterion>
        <criterion id="3">I cannot log in with my credentials until my email is verified.</criterion>
        <criterion id="4">When I click the verification link in my email, then my account is marked as verified in Supabase.</criterion>
        <criterion id="5">After verification, I can successfully log in.</criterion>
    </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/PRD.md" title="Product Requirements Document" section="FR-001: User Authentication &amp; Profile Management" snippet="The system shall allow users to securely register, log in, and manage their core profile information. Users can sign up with email and password, and must verify their email."></doc>
      <doc path="docs/sprint-artifacts/tech-spec-epic-1.md" title="Tech Spec: Epic 1 - First Plan &amp; Foundation" section="Authentication and Authorization" snippet="Authentication: Handled by Supabase Auth, using JWTs for secure sessions. The frontend will manage the JWT, and the backend will validate it for protected endpoints."></doc>
      <doc path="docs/architecture-2025-11-30.md" title="Architecture" section="Authentication" snippet="Supabase (PostgreSQL) for the database, authentication, RLS, and storage. Supabase Auth (using `@supabase/supabase-js` v2.86.0)."></doc>
      <doc path="docs/architecture-2025-11-30.md" title="Architecture" section="Epic to Architecture Mapping" snippet="Epic 1: src/app/(auth)/ (Onboarding UI)."></doc>
      <doc path="docs/architecture-2025-11-30.md" title="Architecture" section="Project Structure" snippet="Frontend project structure includes: frontend/src/app/(auth)/."></doc>
      <doc path="docs/ux-design-specification.md" title="AI Fitness &amp; Meal Planner - UX Design Specification" section="Flow 0: New User Onboarding" snippet="A 5-step guided setup process for new users. Supporting Wireframes: onboarding1_dark.html to onboarding5_dark.html."></doc>
    </docs>
    <code>
      <artifact path="frontend/components/auth/SignUpForm.tsx" kind="component" symbol="SignUpForm" reason="New React component for user registration UI." />
      <artifact path="frontend/lib/supabase.ts" kind="utility" symbol="supabaseClient" reason="New utility for Supabase client initialization." />
      <artifact path="frontend/components/auth/__tests__/SignUpForm.test.tsx" kind="test" symbol="SignUpForm tests" reason="New component tests for SignUpForm." />
      <artifact path="frontend/tests/integration/supabase-auth.test.ts" kind="test" symbol="Supabase authentication integration tests" reason="New integration tests for Supabase authentication flow." />
    </code>
    <dependencies>
        <dependency ecosystem="Python">
            <package name="FastAPI" />
            <package name="uvicorn" />
            <package name="SQLAlchemy" />
            <package name="psycopg2-binary" />
            <package name="alembic" />
            <package name="python-dotenv" />
            <package name="supabase" />
            <package name="pytest" />
        </dependency>
        <dependency ecosystem="Node.js">
            <package name="next" version="16.0.7" />
            <package name="react" version="19.2.0" />
            <package name="react-dom" version="19.2.0" />
            <package name="@tailwindcss/postcss" version="^4" />
            <package name="@testing-library/jest-dom" version="^6.9.1" />
            <package name="@testing-library/react" version="^16.3.0" />
            <package name="@types/node" version="^20" />
            <package name="@types/react" version="^19" />
            <package name="@types/react-dom" version="^19" />
            <package name="eslint" version="^9" />
            <package name="eslint-config-next" version="16.0.7" />
            <package name="jest" version="^30.2.0" />
            <package name="jest-environment-jsdom" version="^30.2.0" />
            <package name="tailwindcss" version="^4" />
            <package name="typescript" version="^5" />
        </dependency>
        <framework name="Next.js" />
        <framework name="FastAPI" />
        <framework name="Supabase" />
        <framework name="Tailwind CSS" />
        <framework name="Jest" />
        <framework name="React Testing Library" />
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architectural-pattern" name="Supabase Client Singleton" description="A singleton instance of the Supabase client should be created in `frontend/lib/supabase.ts` and used throughout the application to ensure consistent configuration and connection management." />
    <constraint type="environment-variables" name="Supabase API Keys" description="Supabase URL and anon key must be stored in `.env.local` and accessed via `process.env.NEXT_PUBLIC_SUPABASE_URL` and `process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY`. Do not hardcode these values." />
    <constraint type="error-handling" name="Supabase API Calls Error Handling" description="All calls to Supabase methods must be wrapped in appropriate try/catch blocks or use promise-based `.then().catch()` handling to manage potential API errors gracefully." />
  </constraints>
  <interfaces>
    <interface name="supabase.auth.signUp()" kind="function-signature" signature="async function signUp(credentials: { email?: string; password?: string; phone?: string; options?: SignUpWithPasswordCredentials['options'] }): Promise&lt;{ data: AuthResponse['data']; error: AuthResponse['error'] }>" path="frontend/lib/supabase.ts" />
    <interface name="supabase.auth.signInWithPassword()" kind="function-signature" signature="async function signInWithPassword(credentials: SignInWithPasswordCredentials): Promise&lt;{ data: AuthResponse['data']; error: AuthResponse['error'] }>" path="frontend/lib/supabase.ts" />
    <interface name="Supabase Client" kind="class-interface" signature="SupabaseClient" path="frontend/lib/supabase.ts" />
  </interfaces>
  <tests>
    <standards>Frontend tests will be written using Jest and React Testing Library. Supabase client interactions should be mocked.</standards>
    <locations>
      <location>frontend/components/auth/__tests__/</location>
      <location>frontend/tests/integration/</location>
    </locations>
    <ideas>
      <idea ac_id="1">Component test for the SignUpForm component to check form rendering and input validation.</idea>
      <idea ac_id="3,5">Integration test to mock the `supabase.auth.signUp` call and verify its behavior on success and error.</idea>
      <idea ac_id="1,3,5">Test to verify that a protected route redirects unauthenticated users.</idea>
    </ideas>
  </tests>
</story-context>
