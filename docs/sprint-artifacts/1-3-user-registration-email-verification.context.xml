<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>3</storyId>
    <title>User Registration &amp; Email Verification</title>
    <status>drafted</status>
    <generatedAt>2025-12-11</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>c:\IT_studier\IBE160_Programmering_med_KI\Prosjektmappe\Prosjekt\SG-Lotte\docs\sprint-artifacts\1-3-user-registration-email-verification.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>new user</asA>
    <iWant>create an account using my email and password</iWant>
    <soThat>I can securely access the application after verifying my email address.</soThat>
    <tasks>
- [ ] **Frontend: Registration Form UI** (AC: #1)
    - [ ] Create a new registration form component in `frontend/src/app/(auth)/signup/page.tsx`.
    - [ ] The form should have fields for email and password.
    - [ ] Implement client-side validation for email format and password strength (e.g., using a library like Zod).

- [ ] **Frontend: Supabase Registration Integration** (AC: #1, #2)
    - [ ] On form submission, call `supabase.auth.signUp({ email, password })` directly from the frontend.
    - [ ] Ensure the function call is wrapped in a `try...catch` block to handle potential errors from Supabase (e.g., user already exists, weak password).
    - [ ] On successful registration, display a success message to the user instructing them to check their email for verification.

- [ ] **Frontend: Login Flow Update** (AC: #3)
    - [ ] Modify the login component to handle unverified users.
    - [ ] When a login attempt is made, check the user's `email_confirmed_at` status from Supabase.
    - [ ] If the email is not confirmed, display a message indicating that the account is pending verification and prevent login.

- [ ] **Frontend: Email Verification Redirect Handling** (AC: #4)
    - [ ] Configure Supabase project settings to redirect to a specific frontend route (e.g., `/auth/email-verified`) after successful email verification.
    - [ ] Create a simple "email verified" screen or handle the redirect to the login page with a success message on the frontend.

- [ ] **Testing**
    - [ ] **Frontend (Unit/Integration):** Write tests for the registration form component, including validation and Supabase call mocking. (AC: #1)
    - [ ] **E2E:** Write an end-to-end test that simulates the entire user registration and email verification flow. This will require mocking email verification or using a test email service. (AC: #1, #2, #3, #4)
</tasks>
  </story>

  <acceptanceCriteria>
1.  **Given** I am a new, unauthenticated user on the signup page,
    **When** I submit a valid email address and a strong password,
    **Then** a new user account is created in the Supabase `auth.users` table.

2.  **Given** a new account has been successfully created,
    **When** the system processes the registration,
    **Then** a verification email with a unique confirmation link is automatically sent to the provided email address.

3.  **Given** I have registered but not yet verified my email,
    **When** I attempt to log in,
    **Then** I am shown a message indicating that my account is pending verification and login is denied.

4.  **Given** I have received the verification email,
    **When** I click the unique verification link,
    **Then** my user account is marked as 'verified' in Supabase, and I am redirected to the login page with a success message.
</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>FR-001: User Authentication &amp; Profile Management</section>
        <snippet>The system shall allow users to securely register, log in, and manage their core profile information. Users can sign up with email and password, and must verify their email.</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>Security (Non-Functional Requirement)</section>
        <snippet>The system handles sensitive personal and health-related data, requiring robust protection against unauthorized access and data breaches. User authentication shall be handled by Supabase Auth using JWT tokens.</snippet>
      </doc>
      <doc>
        <path>docs/architecture-2025-11-30.md</path>
        <title>Architecture</title>
        <section>Project Context</section>
        <snippet>The technical direction is explicitly defined and validated: Frontend: Next.js 14+ (App Router) with TypeScript; Backend: FastAPI (Python); Database &amp; BaaS: Supabase (PostgreSQL) for the database, authentication, RLS, and storage.</snippet>
      </doc>
      <doc>
        <path>docs/architecture-2025-11-30.md</path>
        <title>Architecture</title>
        <section>Epic to Architecture Mapping</section>
        <snippet>Epic 1: First Plan &amp; Foundation - Frontend: `src/app/(auth)/` (Onboarding UI)</snippet>
      </doc>
      <doc>
        <path>docs/architecture-2025-11-30.md</path>
        <title>Architecture</title>
        <section>Technology Stack Details</section>
        <snippet>Authentication: Supabase Auth (using `@supabase/supabase-js` v2.86.0).</snippet>
      </doc>
      <doc>
        <path>docs/architecture-2025-11-30.md</path>
        <title>Architecture</title>
        <section>Integration Points</section>
        <snippet>Frontend to Supabase: The frontend interacts directly with Supabase for authentication and real-time data updates using the `supabase-js` library.</snippet>
      </doc>
      <doc>
        <path>docs/architecture-2025-11-30.md</path>
        <title>Architecture</title>
        <section>Security Architecture</section>
        <snippet>Authentication: Handled by Supabase Auth, a remote managed service, using JWTs for secure sessions.</snippet>
      </doc>
      <doc>
        <path>docs/ux-design-specification.md</path>
        <title>AI Fitness &amp; Meal Planner - UX Design Specification</title>
        <section>Flow 0: New User Onboarding</section>
        <snippet>A 5-step guided setup process for new users. This flow is fully covered and provides a smooth, progressive onboarding experience.</snippet>
      </doc>
      <doc>
        <path>docs/test-design-epic-1.md</path>
        <title>Test Design: Epic 1 - First Plan &amp; Foundation</title>
        <section>Story 1.3: User Registration &amp; Email Verification</section>
        <snippet>Test scenarios and detailed test cases for user registration and email verification, including successful signup, blocked login before verification, and successful email verification.</snippet>
      </doc>
    </docs>
    <code></code>
    <dependencies>
      <ecosystem name="Python">
        <package name="fastapi"/>
        <package name="uvicorn"/>
        <package name="supabase"/>
        <package name="pydantic-settings"/>
        <package name="pydantic-ai"/>
        <package name="python-json-logger"/>
        <package name="pytest"/>
        <package name="pytest-asyncio"/>
      </ecosystem>
      <ecosystem name="Node.js/TypeScript">
        <package name="next"/>
        <package name="react"/>
        <package name="react-dom"/>
        <package name="typescript"/>
        <package name="tailwindcss"/>
        <package name="@supabase/supabase-js"/>
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>User registration and email verification will be handled directly by the frontend interacting with Supabase Auth.</constraint>
    <constraint>All authentication logic is delegated to Supabase Auth, which is the single source of truth for user identity.</constraint>
    <constraint>RLS policies must be in place for any tables containing user data.</constraint>
    <constraint>NEVER hard-code API keys or secrets directly in the source code.</constraint>
    <constraint>For local development, use a `.env.local` file at the root of the `frontend` project to store API keys and secrets.</constraint>
    <constraint>For production, manage secrets as environment variables in platforms like Vercel.</constraint>
  </constraints>
  <interfaces></interfaces>
  <tests>
    <standards>
      The testing strategy for Epic 1, which includes User Registration &amp; Email Verification, is heavily weighted towards integration and E2E tests. The primary goals are to verify the stability of the core technical stack, the security of the authentication flow, and the reliability of the first-time user experience. The authentication and registration flow will be a primary focus, testing for common vulnerabilities, enforcing email verification, and validating password strength policies.
      Frontend unit/integration tests will use Jest &amp; React Testing Library. Backend unit/integration tests will use Pytest. E2E tests will use Playwright.
    </standards>
    <locations>
      Frontend tests: Co-located with components in `__tests__` subdirectory (e.g., `frontend/src/app/(auth)/signup/__tests__/`).
      Backend tests: `backend/tests/`.
    </locations>
    <ideas>
      <idea>
        <description>E2E: Golden Path - Successful user registration and verification.</description>
        <acceptanceCriteriaId>1, 2, 3, 4</acceptanceCriteriaId>
      </idea>
      <idea>
        <description>E2E: Verify login is blocked before email verification.</description>
        <acceptanceCriteriaId>3</acceptanceCriteriaId>
      </idea>
      <idea>
        <description>Integration: API rejects registration with existing email.</description>
        <acceptanceCriteriaId>1</acceptanceCriteriaId>
      </idea>
      <idea>
        <description>Frontend (Unit/Integration): Test registration form component, including validation and Supabase call mocking.</description>
        <acceptanceCriteriaId>1</acceptanceCriteriaId>
      </idea>
      <idea>
        <description>Frontend (Unit/Integration): Test login component to handle unverified users.</description>
        <acceptanceCriteriaId>3</acceptanceCriteriaId>
      </idea>
    </ideas>
  </tests>
</story-context>
