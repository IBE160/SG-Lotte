<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>3</storyId>
    <title>User Registration &amp; Email Verification</title>
    <status>drafted</status>
    <generatedAt>2025-12-09</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-3-user-registration-email-verification.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a new user</asA>
    <iWant>to sign up with my email and password and verify my email</iWant>
    <soThat>I can create a secure account</soThat>
    <tasks>
      <task id="frontend-ui" description="Frontend UI Development (AC: #1, #2, #3)">
        <subtask>Create `frontend/src/app/(auth)/signup/page.tsx` for the signup form.</subtask>
        <subtask>Design and implement the signup form based on `onboarding1_dark.html` (e.g., email, password, confirm password fields).</subtask>
        <subtask>Implement client-side validation for email and password.</subtask>
        <subtask>Display appropriate feedback messages to the user (e.g., success, error) using `feedback_patterns_dark.html`.</subtask>
      </task>
      <task id="supabase-integration" description="Supabase Integration (AC: #1, #2, #3, #4)">
        <subtask>Utilize `frontend/lib/supabaseClient.ts` to implement user registration with email and password.</subtask>
        <subtask>Configure Supabase to send email verification links upon registration.</subtask>
        <subtask>Implement a mechanism to handle user redirection after clicking the verification link (e.g., a dedicated `frontend/src/app/(auth)/verify-email/page.tsx`).</subtask>
        <subtask>Handle Supabase authentication state changes to prevent login until email is verified.</subtask>
      </task>
      <task id="testing" description="Testing (AC: #1, #2, #3, #4)">
        <subtask>Write unit tests for the signup form component (e.g., form submission, input changes, validation).</subtask>
        <subtask>Write integration tests for the Supabase registration and email verification flow (mocking Supabase responses as needed).</subtask>
        <subtask>Implement end-to-end tests (if E2E framework is set up) to simulate the full user registration and email verification process.</subtask>
      </task>
      <task id="documentation" description="Documentation">
        <subtask>Update `frontend/src/app/(auth)/layout.tsx` if necessary for authentication routes.</subtask>
        <subtask>Add notes on any new Supabase Auth configurations.</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">**Given** I am on the signup page, **When** I enter valid email/password and submit, **Then** my account is created in Supabase.</criterion>
    <criterion id="2">**Given** I am on the signup page, **When** I enter valid email/password and submit, **Then** a verification email is sent to my provided email address.</criterion>
    <criterion id="3">**Given** I am on the signup page, **When** I enter valid email/password and submit, **Then** I cannot log in until my email is verified.</criterion>
    <criterion id="4">**When** I click the verification link in my email, **Then** my account is marked as verified.</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>FR-001: User Authentication &amp; Profile Management</section>
        <snippet>Users can sign up with email and password, and must verify their email.</snippet>
      </doc>
      <doc>
        <path>docs/architecture-2025-11-30.md</path>
        <title>Architecture</title>
        <section>Security Architecture</section>
        <snippet>Authentication: Handled by Supabase Auth, using JWTs for secure sessions.</snippet>
      </doc>
	  <doc>
        <path>docs/architecture-2025-11-30.md</path>
        <title>Architecture</title>
        <section>Project Structure</section>
        <snippet>frontend/ src/ app/ (auth)/</snippet>
      </doc>
      <doc>
        <path>docs/architecture-2025-11-30.md</path>
        <title>Architecture</title>
        <section>Epic to Architecture Mapping</section>
        <snippet>Epic 1: First Plan &amp; Foundation - ... Frontend: src/app/(auth)/ (Onboarding UI) ...</snippet>
      </doc>
      <doc>
        <path>docs/architecture-2025-11-30.md</path>
        <title>Architecture</title>
        <section>Implementation Patterns -&gt; Naming Patterns</section>
        <snippet>Frontend Components (React): PascalCase (e.g., UserCard.tsx). Frontend Component Files: Kebab-case (e.g., user-card.tsx).</snippet>
      </doc>
      <doc>
        <path>docs/ux-design-specification.md</path>
        <title>UX Design Specification</title>
        <section>Flow 0: New User Onboarding</section>
        <snippet>Supporting Wireframes: `onboarding1_dark.html` to `onboarding5_dark.html`</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 1.3: User Registration &amp; Email Verification</section>
        <snippet>Technical Notes: Utilizes Supabase Auth for registration and email verification. Frontend UI based on onboarding1_dark.html (implied first step).</snippet>
      </doc>
      <doc>
        <path>docs/test-design-epic-1.md</path>
        <title>Test Design: Epic 1</title>
        <section>High-Priority Risks (Score â‰¥6)</section>
        <snippet>R-002 | SEC | User registration is insecure... Mitigation: Enforce email verification, use Supabase's built-in security features...</snippet>
      </doc>
      <doc>
        <path>docs/test-design-epic-1.md</path>
        <title>Test Design: Epic 1</title>
        <section>P0 (Critical) - Run on every commit</section>
        <snippet>User can register and verify email | E2E | R-002 | 3 | QA | Happy path, invalid email, already registered email.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>frontend/lib/supabaseClient.ts</path>
        <kind>utility</kind>
        <symbol>supabase</symbol>
        <status>reused</status>
        <reason>Provides the Supabase client for all authentication and database interactions.</reason>
      </artifact>
      <artifact>
        <path>frontend/src/app/(auth)/signup/page.tsx</path>
        <kind>component</kind>
        <symbol>SignupPage</symbol>
        <status>new</status>
        <reason>The main page component for the user signup form.</reason>
      </artifact>
      <artifact>
        <path>frontend/src/app/(auth)/verify-email/page.tsx</path>
        <kind>component</kind>
        <symbol>VerifyEmailPage</symbol>
        <status>new</status>
        <reason>A page to handle the email verification callback from Supabase and provide feedback to the user.</reason>
      </artifact>
    </code>
    <dependencies>
      <dependency ecosystem="Node">
        <package>next</package>
        <version>16.0.8</version>
      </dependency>
      <dependency ecosystem="Node">
        <package>react</package>
        <version>19.2.1</version>
      </dependency>
      <dependency ecosystem="Node">
        <package>@supabase/supabase-js</package>
        <version>^2.87.0</version>
      </dependency>
      <dependency ecosystem="Node">
        <package>tailwindcss</package>
        <version>^4</version>
      </dependency>
      <dependency ecosystem="Python">
        <package>supabase</package>
        <version>unknown</version>
      </dependency>
      <dependency ecosystem="Python">
        <package>python-dotenv</package>
        <version>unknown</version>
      </dependency>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Authentication must be handled by Supabase Auth directly from the frontend.</constraint>
    <constraint>All new authentication-related pages must be created under `frontend/src/app/(auth)/`.</constraint>
    <constraint>The existing `frontend/lib/supabaseClient.ts` must be reused for all Supabase interactions.</constraint>
    <constraint>UI components must adhere to the dark theme and feedback patterns defined in the `ux-design-specification.md`.</constraint>
    <constraint>React components must be named using `PascalCase`.</constraint>
    <constraint>Component filenames must be `kebab-case`.</constraint>
    <constraint>Tests must use `React Testing Library` with `Jest`, and Supabase interactions should be mocked for isolated component tests.</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>Supabase Auth signUp</name>
      <kind>function</kind>
      <signature>supabase.auth.signUp(credentials: SignUpWithPasswordCredentials): Promise&lt;{ data: { user: User | null; session: Session | null; }; error: AuthError | null; }&gt;</signature>
      <path>node_modules/@supabase/supabase-js/dist/module/index.d.ts</path>
    </interface>
  </interfaces>
  <tests>
    <standards>
      Frontend component and integration tests will be written using `React Testing Library` with `Jest`. Supabase API calls should be mocked to ensure isolated testing of component logic. E2E tests using a framework like `Playwright` or `Cypress` should be considered once the framework is established.
    </standards>
    <locations>
      <location>frontend/src/app/(auth)/__tests__/</location>
      <location>frontend/src/components/__tests__/</location>
    </locations>
    <ideas>
      <idea for="AC#1">Test that calling `supabase.auth.signUp` successfully creates a user in the mocked Supabase instance.</idea>
      <idea for="AC#1">Test the signup form submission with valid data.</idea>
      <idea for="AC#1">Test client-side validation for invalid email formats and password mismatches.</idea>
      <idea for="AC#2">Verify that `supabase.auth.signUp` is called in a way that triggers an email verification.</idea>
      <idea for="AC#3">Write a test to simulate a login attempt with an unverified email, asserting that it fails.</idea>
      <idea for="AC#4">Test the component/page that handles the verification callback, ensuring it correctly marks the user as verified.</idea>
      <idea for="E2E">An end-to-end test should cover the full happy path: signup -> receive email (mocked) -> click link -> get verified -> log in successfully.</idea>
    </ideas>
  </tests>
</story-context>
