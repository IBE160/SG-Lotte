<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>3</storyId>
    <title>User Registration &amp; Email Verification</title>
    <status>drafted</status>
    <generatedAt>onsdag 3. desember 2025</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-3-user-registration-email-verification.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>As a new user</asA>
    <iWant>I want to sign up with my email and password and verify my email through Supabase Auth</iWant>
    <soThat>so that I can create a secure account and proceed with the onboarding process.</soThat>
    <tasks>
### Frontend Tasks

-   [ ] **Task: Implement Signup UI (based on `onboarding1_dark.html` context)**
    -   [ ] Create `SignupForm` component within `frontend/app/(auth)/signup/` (AC: 1)
    -   [ ] Implement email and password input fields with validation (AC: 1)
    -   [ ] Add a submit button to trigger registration (AC: 1)
    -   [ ] Integrate basic error/success feedback display for user (utilizing `feedback_patterns_dark.html` principles) (AC: 1)
    -   [ ] **Test Subtask:** Write component tests for `SignupForm` using React Testing Library and Jest, covering input changes, submission, and validation errors. (Ref: `docs/architecture-2025-11-30.md` - Frontend Testing) (AC: 1)

-   [ ] **Task: Integrate Supabase Client for Registration**
    -   [ ] Initialize Supabase client in `frontend/lib/supabase.ts` (if not already done)
    -   [ ] Call `supabase.auth.signUp()` with email and password upon form submission (AC: 1)
    -   [ ] Handle successful registration (e.g., redirect to a "check your email" page) (AC: 1)
    -   [ ] Handle registration errors (e.g., display error message to user) (AC: 1)

### Backend Tasks

-   [ ] **Task: Create `/api/v1/users/signup` Endpoint**
    -   [ ] Define a POST endpoint in `backend/app/api/v1/endpoints/users.py` for user registration (AC: 1)
    -   [ ] This endpoint should primarily proxy the request to Supabase Auth's registration functionality (Supabase handles the actual user creation and email sending) (AC: 1)
    -   [ ] Implement request body validation (e.g., Pydantic schema for email and password) (AC: 1)
    -   [ ] Handle responses from Supabase (success/failure) and return appropriate API responses (AC: 1)
    -   [ ] **Test Subtask:** Write integration tests using Pytest for the `/api/v1/users/signup` endpoint, covering successful registration, invalid input, and existing user scenarios. (Ref: `docs/architecture-2025-11-30.md` - Backend Testing) (AC: 1)

-   [ ] **Task: Configure Supabase Auth and RLS**
    -   [ ] Ensure Supabase project is configured to allow email/password authentication (AC: 1, 2)
    -   [ ] Verify email confirmation is enabled in Supabase Auth settings (AC: 1, 2)
    -   [ ] Implement/verify Row Level Security (RLS) policies on the `users` table to ensure only the user themselves can access or modify their own profile data. (Ref: `docs/architecture-2025-11-30.md` - Authorization) (AC: 1, 2)

### General Tasks

-   [ ] **Task: Implement Email Verification Success/Failure UI**
    -   [ ] Create a dedicated page (e.g., `frontend/app/(auth)/verify-email/`) to handle the redirection after a user clicks the email verification link. (AC: 2)
    -   [ ] Display a success message if verification is successful. (AC: 2)
    -   [ ] Display an informative error message if verification fails. (AC: 2)
    -   [ ] Provide guidance on next steps (e.g., "you can now log in"). (AC: 2)
    -   [ ] This page should also leverage `feedback_patterns_dark.html` for visual cues. (AC: 2)

-   [ ] **Task: Update Sprint Status**
    -   [ ] After story completion, update `docs/sprint-artifacts/sprint-status.yaml` to mark this story as `done`.
    </tasks>
  </story>

  <acceptanceCriteria>
1.  **User Registration:**
    *   **Given** a new user is on the signup page (`onboarding1_dark.html` context)
    *   **When** they enter a valid email and password, and submit the form
    *   **Then** a new user account is created in Supabase Auth
    *   **And** a verification email is automatically sent to the provided email address
    *   **And** the user is prevented from logging in until their email is verified

2.  **Email Verification:**
    *   **Given** a user has registered and received a verification email
    *   **When** they click the verification link in the email
    *   **Then** their account status in Supabase Auth is updated to "verified"
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>ibe160 - Product Requirements Document</title>
        <section>FR-001: User Authentication &amp; Profile Management</section>
        <snippet>The system shall allow users to securely register, log in, and manage their core profile information. Users can sign up with email and password, and must verify their email. Users can log in, log out, and reset their password.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>ibe160 - Epic Breakdown</title>
        <section>Epic 1: First Plan &amp; Foundation - Story 1.3: User Registration &amp; Email Verification</section>
        <snippet>As a new user, I want to sign up with my email and password and verify my email, so that I can create a secure account. Acceptance Criteria detail account creation, email verification, and login prevention until verification.</snippet>
      </doc>
      <doc>
        <path>docs/architecture-2025-11-30.md</path>
        <title>Architecture</title>
        <section>Authentication</section>
        <snippet>Authentication will be handled by Supabase Auth, using JWTs for secure sessions. The frontend will manage the JWT, and the backend will validate it for protected endpoints.</snippet>
      </doc>
      <doc>
        <path>docs/architecture-2025-11-30.md</path>
        <title>Architecture</title>
        <section>Authorization</section>
        <snippet>Supabase's Row Level Security (RLS) will be enabled for all tables containing user-specific data to enforce data access policies at the database level.</snippet>
      </doc>
      <doc>
        <path>docs/architecture-2025-11-30.md</path>
        <title>Architecture</title>
        <section>API Design</section>
        <snippet>API endpoints will use plural nouns and kebab-case. All endpoints will be versioned under `/api/v1/`. For user management, a `/users/` endpoint is planned.</snippet>
      </doc>
      <doc>
        <path>docs/architecture-2025-11-30.md</path>
        <title>Architecture</title>
        <section>Project Structure</section>
        <snippet>The project follows a monorepo structure with decoupled `frontend` and `backend` directories. Frontend code should primarily reside under `frontend/app/` and `frontend/components/`.</snippet>
      </doc>
      <doc>
        <path>docs/architecture-2025-11-30.md</path>
        <title>Architecture</title>
        <section>Testing Strategy</section>
        <snippet>Backend: Unit and integration tests using `Pytest`. Frontend: Component and integration tests using `React Testing Library` with `Jest`.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Tech Spec: Epic 1 - First Plan &amp; Foundation</title>
        <section>Authentication and Authorization</section>
        <snippet>Authentication is handled by Supabase Auth using JWTs. The frontend manages the JWT, and the backend validates it. Supabase RLS will be enabled for user-specific data.</snippet>
      </doc>
      <doc>
        <path>docs/ux-design-specification.md</path>
        <title>AI Fitness &amp; Meal Planner - UX Design Specification (Rev. 2)</title>
        <section>Flow 0: New User Onboarding</section>
        <snippet>A 5-step guided setup process for new users, with supporting wireframes from `onboarding1_dark.html` to `onboarding5_dark.html`. This flow is fully covered and provides a smooth, progressive onboarding experience.</snippet>
      </doc>
      <doc>
        <path>docs/ux-design-specification.md</path>
        <title>AI Fitness &amp; Meal Planner - UX Design Specification (Rev. 2)</title>
        <section>Flow 3 &amp; 4: Log Workouts, Meals &amp; Provide Feedback</section>
        <snippet>This section defines feedback patterns (`feedback_patterns_dark.html`) for success, error, and warning feedback after a user action, ensuring immediate confirmation of user actions.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>frontend/app/(auth)/signup/</path>
        <kind>directory</kind>
        <symbol>SignupForm</symbol>
        <reason>Placeholder for new signup UI component</reason>
      </artifact>
      <artifact>
        <path>frontend/lib/supabase.ts</path>
        <kind>utility</kind>
        <symbol>supabase</symbol>
        <reason>Existing Supabase client for authentication operations</reason>
      </artifact>
      <artifact>
        <path>backend/app/api/v1/endpoints/users.py</path>
        <kind>endpoint</kind>
        <symbol>/users/signup</symbol>
        <reason>Location for new user registration API endpoint</reason>
      </artifact>
      <artifact>
        <path>backend/tests/</path>
        <kind>test_directory</kind>
        <symbol>test_main.py (example)</symbol>
        <reason>Location for new backend tests for user registration</reason>
      </artifact>
      <artifact>
        <path>frontend/components/__tests__/</path>
        <kind>test_directory</kind>
        <symbol>HealthCheck.test.tsx (example)</symbol>
        <reason>Example of existing frontend test location; new tests for signup form will be here.</reason>
      </artifact>
    </code>
    <dependencies>
      <dependency>
        <ecosystem>npm</ecosystem>
        <package>next</package>
        <version>16.0.7</version>
      </dependency>
      <dependency>
        <ecosystem>npm</ecosystem>
        <package>react</package>
        <version>19.2.0</version>
      </dependency>
      <dependency>
        <ecosystem>npm</ecosystem>
        <package>react-dom</package>
        <version>19.2.0</version>
      </dependency>
      <dependency>
        <ecosystem>npm</ecosystem>
        <package>supabase/ssr</package>
        <version>0.8.0</version>
      </dependency>
      <dependency>
        <ecosystem>npm</ecosystem>
        <package>supabase/supabase-js</package>
        <version>2.43.4</version>
      </dependency>
      <dependency>
        <ecosystem>npm</ecosystem>
        <package>tailwindcss</package>
        <version>4</version>
      </dependency>
      <dependency>
        <ecosystem>npm</ecosystem>
        <package>typescript</package>
        <version>5</version>
      </dependency>
      <dependency>
        <ecosystem>pip</ecosystem>
        <package>FastAPI</package>
        <version>N/A</version>
      </dependency>
      <dependency>
        <ecosystem>pip</ecosystem>
        <package>uvicorn</package>
        <version>N/A</version>
      </dependency>
      <dependency>
        <ecosystem>pip</ecosystem>
        <package>SQLAlchemy</package>
        <version>N/A</version>
      </dependency>
      <dependency>
        <ecosystem>pip</ecosystem>
        <package>psycopg2-binary</package>
        <version>N/A</version>
      </dependency>
      <dependency>
        <ecosystem>pip</ecosystem>
        <package>alembic</package>
        <version>N/A</version>
      </dependency>
      <dependency>
        <ecosystem>pip</ecosystem>
        <package>python-dotenv</package>
        <version>N/A</version>
      </dependency>
      <dependency>
        <ecosystem>pip</ecosystem>
        <package>supabase</package>
        <version>N/A</version>
      </dependency>
      <dependency>
        <ecosystem>pip</ecosystem>
        <package>pytest</package>
        <version>N/A</version>
      </dependency>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Frontend components for authentication should be located in `frontend/app/(auth)/`.</constraint>
    <constraint>Backend API endpoints for user management should be in `backend/app/api/v1/endpoints/users.py`.</constraint>
    <constraint>Use `frontend/lib/supabase.ts` for Supabase client initialization.</constraint>
    <constraint>Strict adherence to `docs/architecture-2025-11-30.md` for project structure, naming conventions (PascalCase for components, kebab-case for component files), and component organization.</constraint>
    <constraint>Utilize `supabase-js` for frontend-to-Supabase interactions, mirroring the backend's `supabase-py` integration.</constraint>
    <constraint>Backend testing with Pytest, frontend testing with Jest/React Testing Library.</constraint>
    <constraint>RLS (Row Level Security) must be configured for user-related tables in Supabase.</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>Supabase Auth `signUp()`</name>
      <kind>Function signature</kind>
      <signature>async function signUp(email, password)</signature>
      <path>frontend/lib/supabase.ts</path>
    </interface>
    <interface>
      <name>POST /api/v1/users/signup</name>
      <kind>REST endpoint</kind>
      <signature>POST /api/v1/users/signup (email: string, password: string)</signature>
      <path>backend/app/api/v1/endpoints/users.py</path>
    </interface>
  </interfaces>
  <tests>
    <standards>
      Backend testing will use Pytest. Frontend testing will use React Testing Library with Jest. Test files should be co-located with components in `__tests__` subdirectories for frontend, and in the root `backend/tests/` directory for backend.
    </standards>
    <locations>
      <location>backend/tests/</location>
      <location>frontend/app/(auth)/signup/__tests__/</location>
      <location>frontend/components/__tests__/</location>
    </locations>
    <ideas>
      <idea ac_id="1">
        **Frontend Unit/Integration Test:** Verify `SignupForm` component renders correctly, handles input changes, displays validation errors, and triggers `supabase.auth.signUp()` with correct arguments upon submission.
      </idea>
      <idea ac_id="1">
        **Backend Integration Test:** Verify POST `/api/v1/users/signup` endpoint successfully proxies registration to Supabase, handles valid/invalid input, and returns appropriate API responses.
      </idea>
      <idea ac_id="2">
        **Frontend Integration Test:** Verify `verify-email` page correctly handles valid and invalid verification links, displays success/failure messages, and redirects the user to the login page upon successful verification.
      </idea>
      <idea ac_id="1, 2">
        **Supabase RLS Test:** Manually verify (or write a test if possible) that RLS policies prevent unauthorized access to newly created user data.
      </idea>
    </ideas>
  </tests>
</story-context>