<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>Epic 1</epicId>
    <storyId>1.5</storyId>
    <title>Initial AI Plan Generation &amp; Display</title>
    <status>drafted</status>
    <generatedAt>2025-12-02</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-5-initial-ai-plan-generation-display.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>As a new user who has completed onboarding</asA>
    <iWant>I want to immediately see my first AI-generated &quot;diagnostic&quot; workout and meal plan on my dashboard</iWant>
    <soThat>so I can begin my health journey.</soThat>
    <tasks>
| Task ID | Description | Est. Time |
|---|---|---|
| 1.5.1 | Create the backend service (`ai_plan_generator.py`) to interact with the OpenAI GPT-4 API. (AC: #1) | 4h |
| 1.5.2 | Implement the API endpoint to trigger the plan generation. (AC: #1) | 2h |
| 1.5.3 | Integrate the plan generation with the database to store the generated plans. (AC: #3) | 2h |
| 1.5.4 | Implement the frontend dashboard component to display the plan. (AC: #2) | 4h |
| 1.5.5 | **Test:** Write unit tests for the AI plan generator service. (AC: #1) | 1.5h |
| 1.5.6 | **Test:** Write component tests for the dashboard display. (AC: #2) | 1.5h |
| 1.5.7 | **Test:** Write integration tests to verify that the plan is correctly stored in the database. (AC: #3) | 1.5h |
| 1.5.8 | **Test:** Write an E2E test for the entire plan generation and display flow. (AC: #1, #2, #3) | 1.5h |
</tasks>
  </story>

  <acceptanceCriteria>
| # | Given | When | Then |
|---|---|---|---|
| 1 | I have completed the onboarding flow | My dashboard loads | A 7-day personalized workout and meal plan is generated by the AI (OpenAI GPT-4) |
| 2 | A plan has been generated | My dashboard loads | The generated plan is displayed on the dashboard, similar to `dashboard_dark.html` |
| 3 | A plan has been generated | | The plan details are stored in the database |
</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>PRD.md</path>
        <title>ibe160 - Product Requirements Document</title>
        <section>FR-002: AI-Driven Workout Plan Generation &amp; Adaptation</section>
        <snippet>The system shall automatically generate and adapt weekly workout plans based on user goals, logged progress, and difficulty ratings. AI generates a "diagnostic" first-week plan during onboarding.</snippet>
      </doc>
      <doc>
        <path>PRD.md</path>
        <title>ibe160 - Product Requirements Document</title>
        <section>FR-003: AI-Driven Meal Plan Generation &amp; Adaptation</section>
        <snippet>The system shall automatically generate and adapt weekly meal plans based on user goals, dietary preferences, and logged meal consumption. AI generates a "diagnostic" first-week plan during onboarding.</snippet>
      </doc>
      <doc>
        <path>PRD.md</path>
        <title>ibe160 - Product Requirements Document</title>
        <section>FR-006: Dashboard Overview</section>
        <snippet>The system shall provide a clear, minimalist dashboard displaying the user's current weekly workout and meal plans.</snippet>
      </doc>
      <doc>
        <path>PRD.md</path>
        <title>ibe160 - Product Requirements Document</title>
        <section>Non-Functional Requirements: Reliability (AI Integration)</section>
        <snippet>The system shall implement retry mechanisms with exponential backoff for OpenAI API calls. The system shall utilize caching for OpenAI API responses to reduce latency and dependency.</snippet>
      </doc>
      <doc>
        <path>architecture-2025-11-30.md</path>
        <title>Architecture</title>
        <section>System Architecture Alignment</section>
        <snippet>The core AI interaction logic will be encapsulated in the `app/services/ai_plan_generator.py` service. The initial dashboard display in `src/app/(dashboard)/dashboard/`.</snippet>
      </doc>
      <doc>
        <path>architecture-2025-11-30.md</path>
        <title>Architecture</title>
        <section>Technology Stack Details</section>
        <snippet>AI Integration: OpenAI GPT-4 API.</snippet>
      </doc>
      <doc>
        <path>architecture-2025-11-30.md</path>
        <title>Architecture</title>
        <section>Novel Pattern Designs</section>
        <snippet>The core AI-driven functionality for plan generation and adaptation can be successfully implemented using the established "AI Application" pattern.</snippet>
      </doc>
      <doc>
        <path>ux-design-specification.md</path>
        <title>AI Fitness &amp; Meal Planner - UX Design Specification (Rev. 2)</title>
        <section>Flow 1 &amp; 2: Plan Workouts &amp; Meals</section>
        <snippet>AI-powered generation and display of weekly workout and meal plans. Supporting Wireframes: `workoutplan_dark.html`, `mealplan_dark.html`.</snippet>
      </doc>
      <doc>
        <path>sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic Technical Specification: First Plan &amp; Foundation</title>
        <section>Detailed Design: Services and Modules</section>
        <snippet>Backend AI Plan Generator Service: Generate the initial 7-day "diagnostic" workout and meal plan using the OpenAI API. Frontend Dashboard Module: Display the user's workout and meal plan for the current day.</snippet>
      </doc>
      <doc>
        <path>sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic Technical Specification: First Plan &amp; Foundation</title>
        <section>Detailed Design: APIs and Interfaces</section>
        <snippet>POST /plans/generate-initial: Triggers the generation of the initial "diagnostic" workout and meal plan for the authenticated user. GET /plans/today: Fetches the workout and meal plan for the current day.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>backend/app/services/ai_plan_generator.py</path>
        <kind>backend service</kind>
        <symbol>generate_initial_plan</symbol>
        <reason>Core logic for AI plan generation using OpenAI GPT-4 API.</reason>
      </artifact>
      <artifact>
        <path>backend/app/api/v1/endpoints/plans.py</path>
        <kind>backend endpoint</kind>
        <symbol>trigger_plan_generation</symbol>
        <reason>API endpoint to initiate the plan generation process.</reason>
      </artifact>
      <artifact>
        <path>frontend/src/app/(dashboard)/dashboard/page.tsx</path>
        <kind>frontend component</kind>
        <symbol>Dashboard</symbol>
        <reason>Main dashboard component to display the generated plan.</reason>
      </artifact>
      <artifact>
        <path>backend/app/models/workout_plans.py</path>
        <kind>database model</kind>
        <symbol>WorkoutPlan</symbol>
        <reason>Database model for storing workout plans.</reason>
      </artifact>
      <artifact>
        <path>backend/app/models/meal_plans.py</path>
        <kind>database model</kind>
        <symbol>MealPlan</symbol>
        <reason>Database model for storing meal plans.</reason>
      </artifact>
    </code>
    <dependencies>
      <ecosystem name="Node.js">
        <package>zustand</package>
        <package>react</package>
        <package>react-dom</package>
        <package>next</package>
        <package>typescript</package>
        <package>tailwindcss</package>
      </ecosystem>
      <ecosystem name="Python">
        <package>openai</package>
        <package>fastapi</package>
        <package>pydantic</package>
        <package>supabase</package>
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>AI plan generator service must be created at `backend/app/services/ai_plan_generator.py`.</constraint>
    <constraint>API endpoint to trigger plan generation must be in `backend/app/api/v1/endpoints/plans.py`.</constraint>
    <constraint>Frontend dashboard component must be located at `frontend/src/app/(dashboard)/dashboard/page.tsx`.</constraint>
    <constraint>Interaction with the OpenAI API is core to this story.</constraint>
    <constraint>Dashboard UI should be based on `dashboard_dark.html` wireframe concept.</constraint>
    <constraint>Robust error handling, including retry mechanisms with exponential backoff for OpenAI API calls, is critical for AI service reliability.</constraint>
    <constraint>Implement AI Service Resiliency, Fallback, and Caching as per architecture.</constraint>
    <constraint>Plans must be stored in `workout_plans` and `meal_plans` tables.</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>Generate Initial Plan</name>
      <kind>REST endpoint</kind>
      <signature>POST /api/v1/plans/generate-initial</signature>
      <path>backend/app/api/v1/endpoints/plans.py</path>
    </interface>
    <interface>
      <name>Get Today's Plan</name>
      <kind>REST endpoint</kind>
      <signature>GET /api/v1/plans/today</signature>
      <path>backend/app/api/v1/endpoints/plans.py</path>
    </interface>
    <interface>
      <name>OpenAI GPT-4 API</name>
      <kind>External API</kind>
      <signature>OpenAI Chat Completion API</signature>
      <path>https://api.openai.com/v1/chat/completions</path>
    </interface>
  </interfaces>
  <tests>
    <standards>
      Backend unit and integration tests will use Pytest. Frontend component and integration tests will use React Testing Library with Jest. E2E tests will utilize Playwright. Test files will be co-located with components or in root `tests/` directory for backend.
    </standards>
    <locations>
      <location>backend/tests/</location>
      <location>frontend/src/**/__tests__/</location>
    </locations>
    <ideas>
      <idea ac_id="AC: #1">Unit tests for the AI plan generator service.</idea>
      <idea ac_id="AC: #2">Component tests for the dashboard display.</idea>
      <idea ac_id="AC: #3">Integration tests to verify that the plan is correctly stored in the database.</idea>
      <idea ac_id="AC: #1, #2, #3">E2E test for the entire plan generation and display flow.</idea>
    </ideas>
  </tests>
</story-context>