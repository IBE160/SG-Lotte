<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>5</storyId>
    <title>Initial AI Plan Generation & Display</title>
    <status>drafted</status>
    <generatedAt>2025-12-09T12:00:00.000Z</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-5-initial-ai-plan-generation-display.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a new user who has completed onboarding</asA>
    <iWant>to immediately see my first AI-generated "diagnostic" workout and meal plan on my dashboard</iWant>
    <soThat>I can begin my health journey</soThat>
    <tasks>
*   **Backend: AI Plan Generation Service (`ai_plan_generator.py`)**
    *   [ ] Implement `ai_plan_generator.py` service to interact with Pydantic AI framework and Gemini 2.5 (AC: #1)
        *   [ ] Define input parameters based on user preferences (goals, dietary, persona)
        *   [ ] Formulate prompts for Gemini 2.5 to generate 7-day workout and meal plans
        *   [ ] Parse structured JSON response from Gemini 2.5
        *   [ ] Handle potential AI API errors and retries
    *   [ ] Create Pydantic schemas for workout plan and meal plan data structures (AC: #1, #3)
    *   [ ] Implement database integration to store generated plans in `workout_plans` and `meal_plans` tables (AC: #3)
        *   [ ] Define Supabase models for `workout_plans` and `meal_plans`
        *   [ ] Implement CRUD operations for plans
*   **Backend: API Endpoints (`plans.py`)**
    *   [ ] Create FastAPI `POST /api/v1/plans/generate` endpoint (AC: #1, #3)
        *   [ ] Authenticate user via JWT
        *   [ ] Retrieve user preferences from Supabase
        *   [ ] Invoke `ai_plan_generator.py` service
        *   [ ] Store generated plans in DB
        *   [ ] Return confirmation to frontend
    *   [ ] Create FastAPI `GET /api/v1/plans/current` endpoint (AC: #2)
        *   [ ] Authenticate user via JWT
        *   [ ] Retrieve current week's workout and meal plans from DB
        *   [ ] Return structured plan data to frontend
*   **Frontend: Dashboard UI Integration**
    *   [ ] Implement dashboard UI to display generated workout and meal plans (AC: #2)
        *   [ ] Develop components similar to `dashboard_dark.html`
        *   [ ] Integrate with `GET /api/v1/plans/current` to fetch plans
        *   [ ] Visually represent 7-day workout and meal plans
    *   [ ] Integrate `POST /api/v1/plans/generate` call after onboarding completion (AC: #1)
    *   [ ] Handle loading states and error display during plan generation and retrieval
*   **Testing:**
    *   [ ] Write unit and integration tests for `ai_plan_generator.py` (mocking AI API calls)
    *   [ ] Write integration tests for `POST /api/v1/plans/generate` and `GET /api/v1/plans/current` endpoints (mocking Supabase interactions)
    *   [ ] Write component and integration tests for frontend dashboard UI (mocking API calls)
    *   [ ] Implement E2E test for the full flow: onboarding completion -> plan generation -> dashboard display (future consideration, beyond MVP for this story)
    </tasks>
  </story>

  <acceptanceCriteria>
1.  **Given** I have completed the onboarding flow,
    **When** my dashboard loads,
    **Then** a 7-day personalized workout and meal plan is generated by the AI (Pydantic AI framework with Gemini 2.5).
    *   **Source:** Epics.md (Story 1.5), Tech-Spec-Epic-1.md (AC 14)
2.  **Given** I have completed the onboarding flow,
    **When** my dashboard loads,
    **Then** the generated plan is displayed on the dashboard, similar to `dashboard_dark.html` (showing today's plan).
    *   **Source:** Epics.md (Story 1.5), Tech-Spec-Epic-1.md (AC 15)
3.  **Given** I have completed the onboarding flow,
    **When** my dashboard loads,
    **Then** the plan details are stored in the database.
    *   **Source:** Epics.md (Story 1.5), Tech-Spec-Epic-1.md (AC 16)
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <artifact>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic Technical Specification: First Plan & Foundation</title>
        <section>Initial Plan Generation & Display Flow</section>
        <snippet>
          Upon completing onboarding, Frontend calls FastAPI POST /api/v1/plans/generate.
          FastAPI triggers ai_plan_generator.py to interact with Gemini 2.5, using user preferences from Supabase.
          Gemini 2.5 returns structured workout and meal plan.
          FastAPI stores the generated plans in Supabase (workout_plans, meal_plans tables).
          Dashboard loads, calls FastAPI GET /api/v1/plans/current.
          Frontend displays the personalized workout and meal plans.
        </snippet>
      </artifact>
      <artifact>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>FR-002: AI-Driven Workout Plan Generation & Adaptation</section>
        <snippet>
          The system shall automatically generate and adapt weekly workout plans based on user goals, logged progress, and difficulty ratings. AI generates a "diagnostic" first-week plan during onboarding.
        </snippet>
      </artifact>
      <artifact>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>FR-006: Dashboard Overview</section>
        <snippet>
          The system shall provide a clear, minimalist dashboard displaying the user's current weekly workout and meal plans.
        </snippet>
      </artifact>
      <artifact>
        <path>docs/architecture-2025-11-30.md</path>
        <title>Architecture Document</title>
        <section>Epic to Architecture Mapping</section>
        <snippet>
          Epic 1: First Plan & Foundation - Backend: app/services/ai_plan_generator.py (Initial Plan Generation). Frontend: src/app/(dashboard)/dashboard/ (Dashboard UI).
        </snippet>
      </artifact>
      <artifact>
        <path>docs/ux-design-specification.md</path>
        <title>UX Design Specification</title>
        <section>Flow 1 & 2: Plan Workouts & Meals</section>
        <snippet>
          AI-powered generation and display of weekly workout and meal plans. Supporting Wireframes: workoutplan_dark.html, mealplan_dark.html. The core screens for displaying generated plans are well-defined.
        </snippet>
      </artifact>
      <artifact>
        <path>docs/epics.md</path>
        <title>Epics Document</title>
        <section>Story 1.5: Initial AI Plan Generation & Display</section>
        <snippet>
          As a new user who has completed onboarding, I want to immediately see my first AI-generated "diagnostic" workout and meal plan on my dashboard, so I can begin my health journey.
        </snippet>
      </artifact>
    </docs>
    <code>
      <artifact>
        <path>backend/src/app/services/ai_plan_generator.py</path>
        <kind>service</kind>
        <symbol>N/A (New File)</symbol>
        <lines>N/A</lines>
        <reason>Primary service to be created for orchestrating calls to the AI model to generate plans. Does not exist yet.</reason>
      </artifact>
      <artifact>
        <path>backend/src/app/api/v1/endpoints/plans.py</path>
        <kind>controller</kind>
        <symbol>N/A (New File)</symbol>
        <lines>N/A</lines>
        <reason>New API endpoints for plan generation and retrieval will be created here. Does not exist yet.</reason>
      </artifact>
      <artifact>
        <path>frontend/src/app/(dashboard)/dashboard/</path>
        <kind>component</kind>
        <symbol>N/A (New Directory)</symbol>
        <lines>N/A</lines>
        <reason>New dashboard UI components for displaying the generated plan will be created here. Directory does not exist yet.</reason>
      </artifact>
    </code>
    <dependencies>
      <ecosystem name="Node.js">
        <package name="@supabase/supabase-js" version="^2.87.0" />
        <package name="next" version="16.0.8" />
        <package name="react" version="19.2.1" />
        <package name="react-dom" version="19.2.1" />
        <package name="@tailwindcss/postcss" version="^4" />
        <package name="@testing-library/jest-dom" version="^6.9.1" />
        <package name="@testing-library/react" version="^16.3.0" />
        <package name="@types/node" version="^20" />
        <package name="@types/react" version="^19" />
        <package name="@types/react-dom" version="^19" />
        <package name="eslint" version="^9" />
        <package name="eslint-config-next" version="16.0.8" />
        <package name="jest" version="^30.2.0" />
        <package name="jest-environment-jsdom" version="^30.2.0" />
        <package name="tailwindcss" version="^4" />
        <package name="typescript" version="^5" />
      </ecosystem>
      <ecosystem name="Python">
        <package name="fastapi" />
        <package name="pydantic" />
        <package name="supabase" />
        <package name="python-dotenv" />
        <package name="uvicorn" />
        <package name="alembic" />
        <package name="pytest" />
        <package name="pytest-asyncio" />
        <package name="httpx" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Frontend must be built with Next.js (App Router), TypeScript, and Tailwind CSS.</constraint>
    <constraint>Backend must be built with FastAPI on Python 3.14+.</constraint>
    <constraint>All data persistence and user authentication must use the project's Supabase instance.</constraint>
    <constraint>API communication must follow versioned REST patterns (e.g., /api/v1/...) and use Pydantic schemas for validation.</constraint>
    <constraint>Row Level Security (RLS) must be enabled and enforced in Supabase to ensure users can only access their own data.</constraint>
    <constraint>Plan generation must use the Pydantic AI framework with Gemini 2.5.</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>Generate Initial Plan</name>
      <kind>REST</kind>
      <signature>POST /api/v1/plans/generate</signature>
      <path>backend/src/app/api/v1/endpoints/plans.py</path>
    </interface>
    <interface>
      <name>Get Current Plan</name>
      <kind>REST</kind>
      <signature>GET /api/v1/plans/current</signature>
      <path>backend/src/app/api/v1/endpoints/plans.py</path>
    </interface>
  </interfaces>
  <tests>
    <standards>
      <standard>Backend (FastAPI): Unit and integration tests using Pytest. Mock AI API calls.</standard>
      <standard>Frontend (Next.js): Component and integration tests using React Testing Library with Jest. Mock API calls.</standard>
      <standard>End-to-End (E2E): Future consideration, frameworks like Playwright or Cypress may be adopted post-MVP.</standard>
    </standards>
    <locations>
      <location>Backend tests: backend/tests/</location>
      <location>Frontend tests: frontend/src/**/__tests__/</location>
    </locations>
    <ideas>
      <idea>Unit and integration tests for ai_plan_generator.py (mocking AI API calls).</idea>
      <idea>Integration tests for POST /api/v1/plans/generate and GET /api/v1/plans/current endpoints (mocking Supabase interactions).</idea>
      <idea>Component and integration tests for frontend dashboard UI (mocking API calls).</idea>
      <idea>E2E test for the full flow: onboarding completion -> plan generation -> dashboard display (future consideration).</idea>
      <idea>Verify FastAPI app runs locally (AC 1).</idea>
      <idea>Check Supabase connection in backend (AC 2).</idea>
      <idea>Run a sample Alembic migration (AC 3).</idea>
      <idea>Verify Next.js app builds and runs (AC 4).</idea>
      <idea>Push to main branch, observe Vercel deployment (AC 5).</idea>
      <idea>Make a test API call from frontend to backend (AC 6).</idea>
      <idea>Register new user, verify user record in Supabase (AC 7).</idea>
      <idea>Check email inbox for verification link (AC 8).</idea>
      <idea>Attempt login with unverified email (AC 9).</idea>
      <idea>Click verification link, then attempt login (AC 10).</idea>
      <idea>Navigate through 5 onboarding screens (AC 11).</idea>
      <idea>Select different options for preferences (AC 12).</idea>
      <idea>Submit preferences, check Supabase user record (AC 13).</idea>
      <idea>Complete onboarding, verify plan generation via API (AC 14).</idea>
      <idea>Load dashboard after onboarding, observe displayed plan (AC 15).</idea>
      <idea>Verify generated plan details are stored in DB (AC 16).</idea>
    </ideas>
  </tests>
</story-context>
